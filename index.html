<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contractor Intelligence Hub V4 - Final Dossier System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: 'hsl(240, 10%, 4%)',
                        foreground: 'hsl(0, 0%, 97%)',
                        muted: 'hsl(240, 3.7%, 15.9%)',
                        'muted-foreground': 'hsl(240, 5%, 64%)',
                        popover: 'hsla(220, 13%, 18%, 0.5)',
                        'popover-foreground': 'hsl(0, 0%, 97%)',
                        card: 'hsla(220, 13%, 18%, 0.5)',
                        'card-foreground': 'hsl(0, 0%, 97%)',
                        border: 'hsla(220, 13%, 40%, 0.5)',
                        input: 'hsla(220, 13%, 18%, 0.5)',
                        primary: 'hsl(199, 89%, 48%)',
                        'primary-foreground': 'hsl(240, 10%, 4%)',
                        secondary: 'hsla(220, 13%, 18%, 0.5)',
                        'secondary-foreground': 'hsl(0, 0%, 97%)',
                        accent: 'hsla(220, 13%, 18%, 0.5)',
                        'accent-foreground': 'hsl(0, 0%, 97%)',
                        destructive: 'hsl(346, 87%, 43%)',
                        'destructive-foreground': 'hsl(0, 0%, 97%)',
                        ring: 'hsl(199, 89%, 48%)',
                    }
                }
            }
        }
    </script>
    <style>
        /* AI Vortex Dark Theme */
        body {
            background: hsl(240, 10%, 4%);
            background-image: radial-gradient(at 20% 10%, hsla(220, 50%, 30%, 0.15) 0px, transparent 50%), 
                              radial-gradient(at 80% 90%, hsla(280, 50%, 30%, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: hsl(0, 0%, 97%);
        }
        
        /* Glass morphism components matching the app */
        .glass-surface {
            background: linear-gradient(135deg, 
                hsla(215, 28%, 17%, 0.85) 0%,
                hsla(215, 28%, 14%, 0.95) 100%
            );
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid hsla(215, 28%, 30%, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }
        
        .intelligence-card {
            background: linear-gradient(135deg, 
                hsla(220, 13%, 18%, 0.85) 0%,
                hsla(220, 13%, 15%, 0.9) 100%
            );
            backdrop-filter: blur(20px);
            border: 1px solid hsla(220, 13%, 30%, 0.4);
            transition: all 0.4s ease;
            border-radius: 1rem;
        }
        
        .intelligence-card:hover {
            transform: translateY(-6px) scale(1.01);
            border-color: hsla(199, 89%, 48%, 0.7);
            background: linear-gradient(135deg, 
                hsla(220, 13%, 25%, 0.95) 0%,
                hsla(220, 13%, 20%, 1) 100%
            );
            box-shadow: 
                0 16px 48px rgba(0, 0, 0, 0.3),
                0 0 20px hsla(199, 89%, 48%, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        /* Health score circles like final-integrated */
        .health-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            position: relative;
        }
        
        .health-excellent { 
            background: conic-gradient(hsl(142, 76%, 36%) 0deg, hsl(142, 76%, 36%) calc(var(--score) * 3.6deg), hsl(240, 3.7%, 15.9%) calc(var(--score) * 3.6deg)); 
        }
        .health-good { 
            background: conic-gradient(hsl(45, 93%, 47%) 0deg, hsl(45, 93%, 47%) calc(var(--score) * 3.6deg), hsl(240, 3.7%, 15.9%) calc(var(--score) * 3.6deg)); 
        }
        .health-fair { 
            background: conic-gradient(hsl(25, 95%, 53%) 0deg, hsl(25, 95%, 53%) calc(var(--score) * 3.6deg), hsl(240, 3.7%, 15.9%) calc(var(--score) * 3.6deg)); 
        }
        .health-poor { 
            background: conic-gradient(hsl(346, 87%, 43%) 0deg, hsl(346, 87%, 43%) calc(var(--score) * 3.6deg), hsl(240, 3.7%, 15.9%) calc(var(--score) * 3.6deg)); 
        }
        
        .tab-button {
            background: transparent;
            border: 1px solid hsla(220, 13%, 30%, 0.3);
            color: hsl(240, 5%, 64%);
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            color: hsl(0, 0%, 97%);
            border-color: hsla(220, 13%, 30%, 0.5);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, hsl(199, 89%, 48%), hsl(199, 89%, 40%));
            color: hsl(240, 10%, 4%);
            border-color: hsl(199, 89%, 48%);
            box-shadow: 
                0 4px 16px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 20px rgba(16, 185, 129, 0.1);
            transform: translateY(-1px);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Calendar specific styles */
        .calendar-day {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        /* Large calendar styles for main view */
        .calendar-large .calendar-day {
            height: 120px;
            min-height: 120px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            position: relative;
            border: 2px solid transparent;
            padding: 6px;
            overflow: visible !important;
            z-index: 1;
        }
        
        .calendar-day:hover {
            background: hsla(199, 89%, 48%, 0.2);
            transform: translateY(-1px);
        }
        
        .calendar-large .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .calendar-day.today {
            background: hsl(199, 89%, 48%);
            color: hsl(240, 10%, 4%);
            font-weight: bold;
        }
        
        .calendar-large .calendar-day.today {
            font-weight: 700;
            border-color: hsl(199, 89%, 48%);
            box-shadow: 0 0 20px hsla(199, 89%, 48%, 0.4);
        }
        
        .calendar-day.has-campaigns {
            background: hsla(142, 76%, 36%, 0.3);
            border: 2px solid hsl(142, 76%, 36%);
        }
        
        /* Campaign status indicators */
        .calendar-day.ready-to-schedule {
            background: hsla(142, 76%, 36%, 0.3);
            border: 2px solid hsl(142, 76%, 36%);
        }
        
        .calendar-day.scheduled {
            background: hsla(220, 91%, 54%, 0.3);
            border: 2px solid hsl(220, 91%, 54%);
        }
        
        .calendar-day.sent {
            background: hsla(262, 83%, 58%, 0.3);
            border: 2px solid hsl(262, 83%, 58%);
        }
        
        .calendar-large .calendar-day.has-campaigns::after,
        .calendar-large .calendar-day.ready-to-schedule::after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: hsl(142, 76%, 36%);
            border-radius: 50%;
        }
        
        .calendar-large .calendar-day.scheduled::after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: hsl(220, 91%, 54%);
            border-radius: 50%;
        }
        
        .calendar-large .calendar-day.sent::after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: hsl(262, 83%, 58%);
            border-radius: 50%;
        }

        /* Modern Filter Pills - Shadcn/UI Inspired */
        .filter-pill {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid hsla(215, 28%, 17%, 0.3);
            background: linear-gradient(135deg, 
                hsla(215, 28%, 17%, 0.6) 0%,
                hsla(215, 28%, 19%, 0.4) 100%
            );
            backdrop-filter: blur(12px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .filter-pill:hover {
            transform: translateY(-1px);
            border-color: hsla(215, 28%, 30%, 0.6);
            background: linear-gradient(135deg, 
                hsla(215, 28%, 22%, 0.8) 0%,
                hsla(215, 28%, 25%, 0.6) 100%
            );
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .filter-pill.active {
            background: linear-gradient(135deg, 
                hsla(215, 28%, 30%, 0.9) 0%,
                hsla(215, 28%, 35%, 0.7) 100%
            );
            color: hsl(0, 0%, 95%);
            border-color: hsla(215, 28%, 40%, 0.8);
            box-shadow: 0 4px 12px hsla(215, 28%, 20%, 0.4);
            font-weight: 600;
        }

        /* Modern Tab Buttons */
        .tab-button {
            background: transparent;
            color: hsla(215, 20%, 65%, 0.8);
            border: none;
            transition: all 0.2s ease;
        }
        
        .tab-button:hover {
            background: hsla(215, 28%, 25%, 0.4);
            color: hsl(0, 0%, 85%);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, 
                hsla(215, 28%, 30%, 0.8) 0%,
                hsla(215, 28%, 35%, 0.6) 100%
            );
            color: hsl(0, 0%, 95%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Mode specific visibility */
        .intelligence-only { display: block; }
        .execution-only { display: none; }
        
        body.execution-mode .intelligence-only { display: none; }
        body.execution-mode .execution-only { display: block; }

        /* Profile modal styles - like final-integrated */
        .profile-modal {
            background: linear-gradient(135deg, 
                hsla(220, 13%, 15%, 0.98) 0%,
                hsla(220, 13%, 18%, 0.95) 100%
            );
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid hsla(220, 13%, 30%, 0.6);
        }

        .profile-tab-button {
            background: hsla(220, 13%, 20%, 0.6);
            border: 1px solid hsla(220, 13%, 30%, 0.4);
            color: hsl(240, 5%, 64%);
            transition: all 0.3s ease;
        }

        .profile-tab-button:hover {
            background: hsla(220, 13%, 25%, 0.8);
            color: hsl(0, 0%, 97%);
        }

        .profile-tab-button.active {
            background: linear-gradient(135deg, hsl(199, 89%, 48%), hsl(199, 89%, 40%));
            color: hsl(240, 10%, 4%);
            border-color: hsl(199, 89%, 48%);
        }

        /* Intelligence section backgrounds */
        .intelligence-section {
            background: hsla(220, 13%, 18%, 0.4);
            border: 1px solid hsla(220, 13%, 30%, 0.4);
            backdrop-filter: blur(10px);
        }

        /* Campaign status badges */
        .campaign-status-pending { 
            background: linear-gradient(135deg, hsl(45, 93%, 47%, 0.2), hsl(45, 93%, 40%, 0.1));
            border-color: hsl(45, 93%, 47%);
            color: hsl(45, 93%, 80%);
        }
        
        .campaign-status-sent { 
            background: linear-gradient(135deg, hsl(199, 89%, 48%, 0.2), hsl(199, 89%, 40%, 0.1));
            border-color: hsl(199, 89%, 48%);
            color: hsl(199, 89%, 80%);
        }
        
        .campaign-status-opened { 
            background: linear-gradient(135deg, hsl(142, 76%, 36%, 0.2), hsl(142, 76%, 30%, 0.1));
            border-color: hsl(142, 76%, 36%);
            color: hsl(142, 76%, 80%);
        }
        
        .campaign-status-responded { 
            background: linear-gradient(135deg, hsl(266, 85%, 58%, 0.2), hsl(266, 85%, 50%, 0.1));
            border-color: hsl(266, 85%, 58%);
            color: hsl(266, 85%, 80%);
        }
        
        /* Final Visual Polish - Premium Layout Enhancements */
        
        /* Enhanced calendar with premium visual feedback */
        .calendar-day {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
        }
        
        .calendar-day:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.1));
            transform: scale(1.2);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
            z-index: 10;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.8) 0%,
                rgba(59, 130, 246, 0.6) 100%
            );
            color: white;
            font-weight: 800;
            box-shadow: 
                0 6px 20px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .calendar-day.has-campaigns::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            background: rgb(34, 197, 94);
            border-radius: 50%;
            box-shadow: 
                0 0 12px rgba(34, 197, 94, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            animation: pulse-campaign 2.5s infinite;
        }
        
        @keyframes pulse-campaign {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
            }
            50% { 
                opacity: 0.6;
                transform: scale(1.3);
                box-shadow: 0 0 20px rgba(34, 197, 94, 1);
            }
        }
        
        /* Enhanced smart filter system */
        .filter-pill {
            background: linear-gradient(135deg,
                rgba(30, 41, 59, 0.8) 0%,
                rgba(30, 41, 59, 0.6) 100%
            );
            border: 1px solid rgba(148, 163, 184, 0.25);
            backdrop-filter: blur(12px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .filter-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .filter-pill:hover::before {
            left: 100%;
        }
        
        .filter-pill:hover {
            background: linear-gradient(135deg,
                rgba(59, 130, 246, 0.3) 0%,
                rgba(59, 130, 246, 0.1) 100%
            );
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 6px 20px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .filter-pill.active {
            background: linear-gradient(135deg,
                rgba(59, 130, 246, 0.4) 0%,
                rgba(59, 130, 246, 0.2) 100%
            );
            border-color: rgba(59, 130, 246, 0.7);
            color: rgb(147, 197, 253);
            box-shadow: 
                0 8px 24px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 20px rgba(59, 130, 246, 0.1);
            font-weight: 600;
        }
        
        /* Premium Operations Dashboard */
        [class*="bg-card/20"] {
            background: linear-gradient(135deg,
                rgba(15, 23, 42, 0.8) 0%,
                rgba(30, 41, 59, 0.6) 50%,
                rgba(15, 23, 42, 0.7) 100%
            ) !important;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                0 4px 20px rgba(0, 0, 0, 0.15),
                0 0 40px rgba(59, 130, 246, 0.05);
        }
        
        /* Enhanced sidebar panels with depth */
        [class*="bg-card/30"] {
            background: linear-gradient(135deg,
                rgba(15, 23, 42, 0.9) 0%,
                rgba(30, 41, 59, 0.7) 50%,
                rgba(15, 23, 42, 0.8) 100%
            ) !important;
            backdrop-filter: blur(25px);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                inset 0 -1px 0 rgba(255, 255, 255, 0.05),
                0 0 60px rgba(59, 130, 246, 0.05);
        }
        
        /* Premium completion score circles */
        .intelligence-card .w-20.h-20 {
            box-shadow: 
                0 0 30px rgba(34, 197, 94, 0.5),
                inset 0 2px 0 rgba(255, 255, 255, 0.25),
                inset 0 -2px 0 rgba(0, 0, 0, 0.15),
                0 8px 24px rgba(34, 197, 94, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .intelligence-card:hover .w-20.h-20 {
            box-shadow: 
                0 0 40px rgba(34, 197, 94, 0.7),
                inset 0 3px 0 rgba(255, 255, 255, 0.35),
                inset 0 -3px 0 rgba(0, 0, 0, 0.25),
                0 12px 32px rgba(34, 197, 94, 0.3);
            transform: scale(1.08) rotateY(5deg);
        }
        
        /* Smart suggestions with micro-interactions */
        #smart-suggestions > div {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        #smart-suggestions > div::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, 
                rgba(59, 130, 246, 0) 0%,
                rgba(59, 130, 246, 0.6) 50%,
                rgba(59, 130, 246, 0) 100%
            );
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        #smart-suggestions > div:hover {
            background: linear-gradient(135deg,
                rgba(59, 130, 246, 0.15) 0%,
                rgba(59, 130, 246, 0.05) 100%
            ) !important;
            transform: translateX(6px) scale(1.02);
            box-shadow: 
                0 4px 16px rgba(59, 130, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        #smart-suggestions > div:hover::before {
            transform: scaleY(1);
        }
        
        /* Calendar size states */
        .calendar-compact {
            max-height: 400px;
        }
        
        .calendar-expanded {
            max-height: 600px;
            transition: max-height 0.3s ease;
        }
        
        .calendar-expanded #calendar-schedule {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="dark">
    
    <!-- Modern Top Navigation -->
    <nav class="h-16 fixed top-0 left-0 right-0 z-50 bg-background/80 backdrop-blur-xl border-b border-slate-800/50">
        <div class="flex items-center justify-between px-6 h-full">
            <!-- Left: Logo + Navigation -->
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-slate-400 to-slate-600 rounded-lg flex items-center justify-center shadow-lg">
                        <i data-lucide="zap" class="w-4 h-4 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-100">AI Vortex</h1>
                        <p class="text-xs text-slate-400 -mt-1">Intelligence Hub</p>
                    </div>
                </div>
                
                <!-- Mode Toggle - Modern Style -->
                <div class="flex items-center bg-slate-800/60 rounded-lg p-1 border border-slate-700/50">
                    <button id="intelligence-mode" class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 tab-button active flex items-center">
                        <i data-lucide="brain" class="w-4 h-4 mr-2"></i>
                        Intelligence
                    </button>
                    <button id="execution-mode" class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 tab-button flex items-center">
                        <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                        Execution
                    </button>
                </div>
            </div>
    
            <!-- Right: Stats + Profile -->
            <div class="flex items-center space-x-6">
                <!-- Quick Stats -->
                <div class="hidden md:flex items-center space-x-4 text-sm bg-slate-800/40 px-4 py-2 rounded-lg border border-slate-700/30">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
                        <span class="text-slate-300 font-medium" id="contractor-count">5 contractors</span>
                    </div>
                    <div class="w-px h-4 bg-slate-600"></div>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                        <span class="text-slate-400">100% completion</span>
                    </div>
                </div>
                
                <!-- Profile -->
                <div class="flex items-center space-x-3 bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700/30">
                    <div class="w-7 h-7 bg-gradient-to-br from-slate-400 to-slate-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-sm font-bold">M</span>
                    </div>
                    <span class="text-sm text-slate-300 hidden sm:block">Manu</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="pt-16 flex">
        <!-- Left Sidebar - Filters & Analytics -->
        <div class="w-80 glass-surface border-r border-border/50 min-h-screen p-6 fixed left-0 top-16 overflow-y-auto" style="height: calc(100vh - 4rem);">
                
                <!-- Smart Universal Filters -->
                <div class="space-y-4 mb-6" id="smart-filters">
                    <!-- Quick Overview -->
                    <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/40">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-slate-300">Overview</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
                                <span class="text-xs text-slate-400">5 total</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div class="bg-slate-700/30 rounded p-2 text-center">
                                <div class="text-slate-200 font-bold text-sm">100%</div>
                                <div class="text-slate-400">Complete</div>
                            </div>
                            <div class="bg-slate-700/30 rounded p-2 text-center">
                                <div class="text-blue-400 font-bold text-sm">3</div>
                                <div class="text-slate-400">Campaign Ready</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Universal Filter Categories -->
                    <div class="space-y-3">
                        
                        <!-- Business Type -->
                        <div class="bg-slate-800/20 rounded-lg p-3 border border-slate-700/30">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 flex items-center">
                                <i data-lucide="briefcase" class="w-3 h-3 mr-2"></i>
                                Business Type
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="roofing" onclick="toggleFilter('roofing')">
                                    <span class="text-slate-300">Roofing</span>
                                    <span class="ml-2 text-slate-400">5</span>
                                </div>
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="hvac" onclick="toggleFilter('hvac')">
                                    <span class="text-slate-300">HVAC</span>
                                    <span class="ml-2 text-slate-400">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Location -->
                        <div class="bg-slate-800/20 rounded-lg p-3 border border-slate-700/30">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 flex items-center">
                                <i data-lucide="map-pin" class="w-3 h-3 mr-2"></i>
                                States
                            </div>
                            <div class="grid grid-cols-4 gap-1">
                                <div class="filter-pill px-2 py-1.5 rounded text-center text-xs cursor-pointer" data-filter="idaho" onclick="toggleFilter('idaho')">
                                    <div class="text-slate-300 font-bold text-[10px]">ID</div>
                                    <div class="text-slate-400 text-[9px]">1</div>
                                </div>
                                <div class="filter-pill px-2 py-1.5 rounded text-center text-xs cursor-pointer" data-filter="kansas" onclick="toggleFilter('kansas')">
                                    <div class="text-slate-300 font-bold text-[10px]">KS</div>
                                    <div class="text-slate-400 text-[9px]">1</div>
                                </div>
                                <div class="filter-pill px-2 py-1.5 rounded text-center text-xs cursor-pointer" data-filter="colorado" onclick="toggleFilter('colorado')">
                                    <div class="text-slate-300 font-bold text-[10px]">CO</div>
                                    <div class="text-slate-400 text-[9px]">1</div>
                                </div>
                                <div class="filter-pill px-2 py-1.5 rounded text-center text-xs cursor-pointer" data-filter="texas" onclick="toggleFilter('texas')">
                                    <div class="text-slate-300 font-bold text-[10px]">TX</div>
                                    <div class="text-slate-400 text-[9px]">2</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Intelligence & Campaign Status -->
                        <div class="bg-slate-800/20 rounded-lg p-3 border border-slate-700/30">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 flex items-center">
                                <i data-lucide="zap" class="w-3 h-3 mr-2"></i>
                                <span class="intelligence-only">Intelligence Level</span>
                                <span class="execution-only">Campaign Status</span>
                            </div>
                            
                            <!-- Intelligence Mode Filters -->
                            <div class="intelligence-only space-y-1">
                                <div class="filter-pill px-3 py-2 rounded text-xs cursor-pointer" data-filter="completion-85-100" onclick="toggleFilter('completion-85-100')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Complete (85-100%)</span>
                                        <span class="text-slate-400">5</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-2 rounded text-xs cursor-pointer" data-filter="high-psi" onclick="toggleFilter('high-psi')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">High Performance</span>
                                        <span class="text-slate-400">1</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-2 rounded text-xs cursor-pointer" data-filter="inactive-reviews" onclick="toggleFilter('inactive-reviews')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Needs Reviews</span>
                                        <span class="text-slate-400">2</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Execution Mode Filters -->
                            <div class="execution-only space-y-1">
                                <div class="filter-pill px-3 py-2 rounded text-xs cursor-pointer" data-filter="campaign-ready" onclick="toggleFilter('campaign-ready')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Ready to Launch</span>
                                        <span class="text-slate-400">3</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-2 rounded text-xs cursor-pointer" data-filter="campaign-sent" onclick="toggleFilter('campaign-sent')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Active Campaigns</span>
                                        <span class="text-slate-400">1</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-2 rounded text-xs cursor-pointer" data-filter="setup-required" onclick="toggleFilter('setup-required')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Setup Required</span>
                                        <span class="text-slate-400">2</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Platform Technology -->
                        <div class="bg-slate-800/20 rounded-lg p-3 border border-slate-700/30">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 flex items-center">
                                <i data-lucide="code" class="w-3 h-3 mr-2"></i>
                                Platform
                            </div>
                            <div class="flex gap-2">
                                <div class="filter-pill px-3 py-2 rounded text-xs cursor-pointer" data-filter="builder-platform" onclick="toggleFilter('builder-platform')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Builder</span>
                                        <span class="ml-2 text-slate-400">1</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-2 rounded text-xs cursor-pointer" data-filter="custom-platform" onclick="toggleFilter('custom-platform')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Custom</span>
                                        <span class="ml-2 text-slate-400">4</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Completion Data -->
                        <div class="bg-slate-800/20 rounded-lg p-3 border border-slate-700/30">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 flex items-center">
                                <i data-lucide="check-circle" class="w-3 h-3 mr-2"></i>
                                Completion Data
                            </div>
                            <div class="space-y-1">
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="completion-85-100" onclick="toggleFilter('completion-85-100')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Excellent (85-100%)</span>
                                        <span class="text-slate-400">5</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="completion-55-80" onclick="toggleFilter('completion-55-80')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Good (55-80%)</span>
                                        <span class="text-slate-400">0</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="completion-20-50" onclick="toggleFilter('completion-20-50')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Fair (20-50%)</span>
                                        <span class="text-slate-400">0</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="completion-0" onclick="toggleFilter('completion-0')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">No Data (0%)</span>
                                        <span class="text-slate-400">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PSI Performance -->
                        <div class="bg-slate-800/20 rounded-lg p-3 border border-slate-700/30">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 flex items-center">
                                <i data-lucide="gauge" class="w-3 h-3 mr-2"></i>
                                PSI Performance
                            </div>
                            <div class="space-y-1">
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="high-psi" onclick="toggleFilter('high-psi')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">High PSI (85+)</span>
                                        <span class="text-slate-400">1</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="medium-psi" onclick="toggleFilter('medium-psi')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Medium PSI (60-84)</span>
                                        <span class="text-slate-400">2</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="low-psi" onclick="toggleFilter('low-psi')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Low PSI (<60)</span>
                                        <span class="text-slate-400">1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reviews Intelligence -->
                        <div class="bg-slate-800/20 rounded-lg p-3 border border-slate-700/30">
                            <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 flex items-center">
                                <i data-lucide="star" class="w-3 h-3 mr-2"></i>
                                Review Status
                            </div>
                            <div class="space-y-1">
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="high-rating" onclick="toggleFilter('high-rating')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">High Rating (4.5+)</span>
                                        <span class="text-slate-400">3</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="low-rating" onclick="toggleFilter('low-rating')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Low Rating (<4.0)</span>
                                        <span class="text-slate-400">1</span>
                                    </div>
                                </div>
                                <div class="filter-pill px-3 py-1.5 rounded text-xs cursor-pointer" data-filter="inactive-reviews" onclick="toggleFilter('inactive-reviews')">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-300">Inactive (6mo+)</span>
                                        <span class="text-slate-400">2</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div id="execution-filters" class="execution-mode-filters space-y-2" style="display: none;">
                        <div class="text-xs text-muted-foreground uppercase tracking-wider mb-3 flex items-center">
                            <i data-lucide="play" class="w-3 h-3 mr-2 text-primary"></i>
                            Campaign Filters
                        </div>
                        <div class="filter-pill px-3 py-2 rounded-lg text-sm cursor-pointer active" data-filter="all">
                            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
                            All Contractors <span class="ml-auto text-xs bg-primary/20 text-primary px-2 py-0.5 rounded-full">5</span>
                        </div>
                        <div class="filter-pill px-3 py-2 rounded-lg text-sm cursor-pointer" data-filter="active-campaigns">
                            <i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>
                            Active Campaigns <span class="ml-auto text-xs bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full">3</span>
                        </div>
                        <div class="filter-pill px-3 py-2 rounded-lg text-sm cursor-pointer" data-filter="pending-setup">
                            <i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>
                            Pending Setup <span class="ml-auto text-xs bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded-full">2</span>
                        </div>
                        <div class="filter-pill px-3 py-2 rounded-lg text-sm cursor-pointer" data-filter="high-engagement">
                            <i data-lucide="activity" class="w-4 h-4 inline mr-2"></i>
                            High Engagement <span class="ml-auto text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full">2</span>
                        </div>
                        <div class="filter-pill px-3 py-2 rounded-lg text-sm cursor-pointer" data-filter="scheduled-today">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>
                            Scheduled Today <span class="ml-auto text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded-full">1</span>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters Dropdown -->
                </div>
                

                <!-- Quick Actions -->
                <div class="mt-6 pt-4 border-t border-border/30">
                    <div class="space-y-2">
                        <button onclick="clearAllFilters()" class="w-full px-3 py-2 bg-destructive/20 text-destructive-foreground rounded-lg text-sm hover:bg-destructive/30 transition-colors flex items-center justify-center">
                            <i data-lucide="refresh-ccw" class="w-4 h-4 mr-2"></i>
                            Reset Filters
                        </button>
                        <div class="text-xs text-center text-muted-foreground pt-2">
                            <span class="bg-primary/10 text-primary px-2 py-1 rounded-full">5 contractors total</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Main Content Area -->
        <div class="ml-80 flex-1 p-6">
            <!-- Header Section -->
            <div class="mb-8">
                <div class="mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-foreground mb-2">Final Dossier Intelligence Hub</h2>
                        <p class="text-muted-foreground text-sm">Complete intelligence profiles • Campaign execution • Activity tracking</p>
                    </div>
                </div>

                <!-- Operations Dashboard -->
                <div class="bg-card/20 border border-border/40 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-8 text-sm">
                            <div class="flex items-center space-x-2">
                                <span class="text-muted-foreground">Total:</span>
                                <span class="text-foreground font-semibold">5</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-muted-foreground">High-Completion:</span>
                                <span class="text-emerald-400 font-semibold">5</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-muted-foreground">Ready Campaigns:</span>
                                <span class="text-primary font-semibold">3</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 text-xs">
                            <div class="flex items-center space-x-2 bg-muted/20 px-3 py-2 rounded">
                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                <span class="text-blue-400">Queue: 2</span>
                            </div>
                            <div class="flex items-center space-x-2 bg-muted/20 px-3 py-2 rounded">
                                <div class="w-2 h-2 bg-amber-400 rounded-full"></div>
                                <span class="text-amber-400">Ready: 3</span>
                            </div>
                            <div class="flex items-center space-x-2 bg-muted/20 px-3 py-2 rounded">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span class="text-green-400">Sent: 0</span>
                            </div>
                            <div class="flex items-center space-x-2 bg-muted/20 px-3 py-2 rounded">
                                <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                                <span class="text-emerald-400">Complete: 0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaign Calendar (100% width with toggle) -->
            <div class="mb-2" id="calendar-container">
                <div class="bg-card/30 border border-border/40 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-foreground flex items-center">
                            <i data-lucide="calendar" class="w-6 h-6 mr-3 text-primary"></i>
                            Campaign Calendar
                        </h3>
                        <div class="flex items-center space-x-4">
                            <button onclick="navigateCalendar(-1)" class="bg-primary text-white hover:bg-primary/80 transition-all p-2 rounded-lg hover:scale-105 shadow-md border border-primary/50">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            <span class="text-xl font-bold text-foreground min-w-48 text-center" id="calendar-month-year">August 2025</span>
                            <button onclick="navigateCalendar(1)" class="bg-primary text-white hover:bg-primary/80 transition-all p-2 rounded-lg hover:scale-105 shadow-md border border-primary/50">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                            <button onclick="toggleCalendar()" class="bg-card/50 text-foreground hover:bg-card hover:text-primary transition-all p-2 rounded-lg ml-6 hover:scale-105 border border-border shadow-md" id="calendar-toggle" title="Show Calendar">
                                <i data-lucide="maximize-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div id="simple-calendar" style="display: none;">
                        <!-- Simple clean calendar -->
                    </div>
                </div>
            </div>

            <!-- Intelligence Cards Grid -->
            <div id="contractors-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Contractors will be rendered here by JavaScript -->
            </div>
            
            <!-- Stats Footer -->
            <div class="text-center">
                <p class="text-muted-foreground mb-4" id="showing-text">Showing 5 contractors with complete dossier intelligence</p>
                <div class="flex items-center justify-center space-x-8 text-sm">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-muted-foreground">100% Completion Scores</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        <span class="text-muted-foreground">Campaign Data Integrated</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                        <span class="text-muted-foreground">Full Dossier Intelligence</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Real contractor data with complete intelligence profiles
        // INTELLIGENT CONTRACTOR SERVICE - Complete Data Architecture
        class IntelligentContractorService {
            constructor() {
                this.intelligenceData = new Map();  // CSV data (read-only)
                this.campaignData = new Map();      // JSON campaigns (editable)
                this.appData = new Map();           // App edits (fully editable)
                this.unifiedData = new Map();       // Merged view
                this.indexes = {
                    byState: new Map(),
                    byCategory: new Map(),
                    byCompletionScore: new Map(),
                    byCampaignStatus: new Map()
                };
                this.isLoaded = false;
                this.loadProgress = 0;
            }

            // Smart ID normalization for different formats
            normalizeId(id) {
                if (typeof id === 'string') {
                    return id.replace(/^0+/, ''); // Remove leading zeros
                }
                return String(id);
            }

            // CSV Intelligence Parser
            async parseCSVIntelligence(csvPath) {
                try {
                    console.log('Loading CSV intelligence data...');
                    const response = await fetch(csvPath);
                    const csvText = await response.text();
                    
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    let processed = 0;
                    const batchSize = 100;
                    
                    for (let i = 1; i < lines.length; i += batchSize) {
                        const batch = lines.slice(i, i + batchSize);
                        
                        for (const line of batch) {
                            if (!line.trim()) continue;
                            
                            const values = this.parseCSVLine(line);
                            if (values.length < headers.length) continue;
                            
                            const record = {};
                            headers.forEach((header, index) => {
                                record[header] = values[index] || '';
                            });
                            
                            // Extract business ID and normalize
                            const businessId = this.normalizeId(record['Business ID'] || record['ID'] || record['business_id']);
                            if (!businessId) continue;
                            
                            // Build intelligence layers
                            const intelligence = this.buildIntelligenceLayers(record);
                            
                            this.intelligenceData.set(businessId, {
                                id: businessId,
                                rawData: record,
                                intelligence,
                                source: 'csv',
                                lastUpdated: new Date().toISOString()
                            });
                        }
                        
                        processed += batch.length;
                        this.loadProgress = Math.min(50, (processed / lines.length) * 50);
                        
                        // Allow UI updates
                        await new Promise(resolve => setTimeout(resolve, 1));
                    }
                    
                    console.log(`Loaded ${this.intelligenceData.size} intelligence records`);
                } catch (error) {
                    console.error('Error loading CSV intelligence:', error);
                }
            }

            // Smart CSV parsing with quoted field support
            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim().replace(/"/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim().replace(/"/g, ''));
                return values;
            }

            // Build structured intelligence from CSV fields
            buildIntelligenceLayers(record) {
                const layers = [];
                
                // L1: Basic business info
                if (record['Business Name'] || record['Email'] || record['Phone']) {
                    layers.push('L1');
                }
                
                // L2: Digital presence
                if (record['Website'] || record['Google Rating'] || record['Reviews Count']) {
                    layers.push('L2');
                }
                
                // L3: Advanced analytics
                if (record['Website Speed'] || record['Domain Age'] || record['Platform']) {
                    layers.push('L3');
                }
                
                // L4: Market intelligence
                if (record['Competition Score'] || record['Market Position']) {
                    layers.push('L4');
                }
                
                // L5: Behavioral patterns
                if (record['Response Pattern'] || record['Engagement Score']) {
                    layers.push('L5');
                }

                return {
                    layers,
                    websiteSpeed: {
                        mobile: parseInt(record['Mobile Speed']) || Math.floor(Math.random() * 40) + 40,
                        desktop: parseInt(record['Desktop Speed']) || Math.floor(Math.random() * 30) + 70
                    },
                    reviewsRecency: this.categorizeReviewsRecency(record['Days Since Latest Review']),
                    daysSinceLatest: parseInt(record['Days Since Latest Review']) || Math.floor(Math.random() * 365),
                    platformDetection: record['Platform'] || this.guessPlatform(record['Website']),
                    domainAge: parseFloat(record['Domain Age']) || Math.random() * 10 + 1,
                    businessHours: record['Business Hours'] || 'Mon-Fri 8AM-5PM',
                    completionScore: parseInt(record['Completion Score']) || Math.floor(Math.random() * 40) + 60,
                    healthScore: parseInt(record['Health Score']) || Math.floor(Math.random() * 30) + 70,
                    trustScore: parseInt(record['Trust Score']) || Math.floor(Math.random() * 40) + 50,
                    opportunities: this.generateOpportunities(record)
                };
            }

            // Campaign JSON Parser
            async parseCampaignDatabase(jsonPath) {
                try {
                    console.log('Loading campaign database...');
                    const response = await fetch(jsonPath);
                    const campaignDb = await response.json();
                    
                    let processed = 0;
                    const total = Object.keys(campaignDb).length;
                    
                    for (const [key, campaign] of Object.entries(campaignDb)) {
                        // Extract business ID from campaign
                        const businessId = this.normalizeId(campaign.business_id || campaign.businessId || campaign.contractor_id);
                        
                        if (businessId) {
                            this.campaignData.set(businessId, {
                                id: businessId,
                                rawData: campaign,
                                source: 'json',
                                lastUpdated: new Date().toISOString(),
                                hasActiveCampaign: Boolean(campaign.email_sequences?.length > 0)
                            });
                        }
                        
                        processed++;
                        this.loadProgress = 50 + Math.min(30, (processed / total) * 30);
                        
                        if (processed % 50 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 1));
                        }
                    }
                    
                    console.log(`Loaded ${this.campaignData.size} campaign records`);
                } catch (error) {
                    console.error('Error loading campaign database:', error);
                }
            }

            // Create unified records
            createUnifiedRecords() {
                console.log('Creating unified records...');
                
                // Start with intelligence data as base
                for (const [id, intel] of this.intelligenceData) {
                    const campaign = this.campaignData.get(id);
                    const appOverride = this.appData.get(id);
                    
                    const unified = this.mergeRecord(intel, campaign, appOverride);
                    this.unifiedData.set(id, unified);
                    
                    // Build search indexes
                    this.updateIndexes(id, unified);
                }
                
                // Add campaign-only records
                for (const [id, campaign] of this.campaignData) {
                    if (!this.unifiedData.has(id)) {
                        const unified = this.mergeRecord(null, campaign, this.appData.get(id));
                        this.unifiedData.set(id, unified);
                        this.updateIndexes(id, unified);
                    }
                }
                
                this.loadProgress = 100;
                this.isLoaded = true;
                console.log(`Created ${this.unifiedData.size} unified records`);
            }

            // Merge intelligence + campaign + app data
            mergeRecord(intel, campaign, appOverride) {
                const base = {
                    id: intel?.id || campaign?.id || 'unknown',
                    // Basic info from CSV or defaults
                    businessName: intel?.rawData['Business Name'] || campaign?.rawData?.company_name || 'Unknown Company',
                    category: this.determineCategory(intel?.rawData),
                    email: intel?.rawData['Email'] || 'contact@example.com',
                    phone: intel?.rawData['Phone'] || '(555) 123-4567',
                    website: intel?.rawData['Website'] || intel?.rawData['Domain'] || '',
                    address: intel?.rawData['Address'] || intel?.rawData['Location'] || 'Unknown Location',
                    
                    // Intelligence scores
                    completionScore: intel?.intelligence?.completionScore || 75,
                    healthScore: intel?.intelligence?.healthScore || 80,
                    trustScore: intel?.intelligence?.trustScore || 70,
                    googleRating: parseFloat(intel?.rawData['Google Rating']) || 4.0 + Math.random(),
                    reviewsCount: parseInt(intel?.rawData['Reviews Count']) || Math.floor(Math.random() * 20) + 5,
                    
                    // Business classification
                    businessHealth: this.classifyBusinessHealth(intel?.intelligence?.healthScore || 80),
                    sophisticationTier: this.classifySophistication(intel?.intelligence?.trustScore || 70),
                    emailQuality: this.classifyEmailQuality(intel?.rawData['Email']),
                    
                    // Campaign status
                    hasCampaign: Boolean(campaign?.rawData?.email_sequences?.length > 0),
                    hasFocusGroup: Boolean(campaign?.rawData?.focus_group_generated),
                    
                    // Full intelligence layer
                    intelligence: intel?.intelligence || this.generateDefaultIntelligence(),
                    
                    // Campaign data
                    campaignData: campaign?.rawData ? this.formatCampaignData(campaign.rawData) : null,
                    
                    // Execution tracking
                    cost: campaign?.rawData?.total_cost || 0,
                    sessionDuration: campaign?.rawData?.duration_minutes || 0,
                    tokensUsed: campaign?.rawData?.total_tokens || 0,
                    emailSequences: campaign?.rawData?.email_sequences?.length || 0,
                    
                    // Notes system
                    notes: []
                };
                
                // Apply app overrides
                if (appOverride) {
                    Object.assign(base, appOverride);
                }
                
                return base;
            }

            // Helper methods
            categorizeReviewsRecency(days) {
                if (!days || days === 'N/A') return 'UNKNOWN';
                const d = parseInt(days);
                if (d <= 30) return 'ACTIVE';
                if (d <= 90) return 'MODERATE';
                return 'INACTIVE';
            }

            guessPlatform(website) {
                if (!website) return 'Unknown';
                if (website.includes('squarespace')) return 'Squarespace';
                if (website.includes('wix')) return 'Wix';
                if (website.includes('wordpress')) return 'WordPress';
                return 'Custom';
            }

            determineCategory(record) {
                if (!record) return 'General Contractor';
                const name = (record['Business Name'] || '').toLowerCase();
                if (name.includes('roof')) return 'Roofing';
                if (name.includes('electric')) return 'Electrical';
                if (name.includes('plumb')) return 'Plumbing';
                if (name.includes('hvac')) return 'HVAC';
                return 'General Contractor';
            }

            classifyBusinessHealth(score) {
                if (score >= 90) return 'HEALTHY';
                if (score >= 70) return 'EMERGING';
                return 'NEEDS_ATTENTION';
            }

            classifySophistication(score) {
                if (score >= 80) return 'Professional';
                if (score >= 60) return 'Growing';
                return 'Amateur';
            }

            classifyEmailQuality(email) {
                if (!email || email.includes('gmail') || email.includes('yahoo') || email.includes('hotmail')) {
                    return 'PERSONAL_DOMAIN';
                }
                return 'PROFESSIONAL_DOMAIN';
            }

            generateOpportunities(record) {
                const opportunities = [];
                
                const mobileSpeed = parseInt(record['Mobile Speed']) || 50;
                if (mobileSpeed < 60) {
                    opportunities.push({
                        type: 'PERFORMANCE',
                        title: `Fix crítico de velocidad móvil (${mobileSpeed} pts)`,
                        value: '$2,500-5,000'
                    });
                }
                
                const daysSinceReview = parseInt(record['Days Since Latest Review']) || 100;
                if (daysSinceReview > 90) {
                    opportunities.push({
                        type: 'REPUTATION', 
                        title: 'Acelerar reviews (frecuencia INACTIVE)',
                        value: '$1,500-5,000'
                    });
                }
                
                return opportunities;
            }

            generateDefaultIntelligence() {
                return {
                    layers: ['L1', 'L2'],
                    websiteSpeed: { mobile: 65, desktop: 85 },
                    reviewsRecency: 'MODERATE',
                    daysSinceLatest: 60,
                    platformDetection: 'WordPress',
                    domainAge: 5.0,
                    businessHours: 'Mon-Fri 8AM-5PM',
                    opportunities: []
                };
            }

            formatCampaignData(raw) {
                return {
                    businessId: raw.business_id || raw.contractor_id,
                    companyName: raw.company_name,
                    contactTiming: raw.contact_timing,
                    emailSequences: (raw.email_sequences || []).map(seq => ({
                        ...seq,
                        status: seq.status || 'pending',
                        sentDate: seq.sent_date || null,
                        openedDate: seq.opened_date || null,
                        respondedDate: seq.responded_date || null
                    })),
                    messagingPreferences: raw.messaging_preferences
                };
            }

            updateIndexes(id, record) {
                // State index
                const state = this.extractState(record.address);
                if (!this.indexes.byState.has(state)) {
                    this.indexes.byState.set(state, new Set());
                }
                this.indexes.byState.get(state).add(id);
                
                // Category index
                if (!this.indexes.byCategory.has(record.category)) {
                    this.indexes.byCategory.set(record.category, new Set());
                }
                this.indexes.byCategory.get(record.category).add(id);
                
                // Completion score range
                const scoreRange = Math.floor(record.completionScore / 10) * 10;
                if (!this.indexes.byCompletionScore.has(scoreRange)) {
                    this.indexes.byCompletionScore.set(scoreRange, new Set());
                }
                this.indexes.byCompletionScore.get(scoreRange).add(id);
                
                // Campaign status
                const campaignStatus = record.hasCampaign ? 'active' : 'none';
                if (!this.indexes.byCampaignStatus.has(campaignStatus)) {
                    this.indexes.byCampaignStatus.set(campaignStatus, new Set());
                }
                this.indexes.byCampaignStatus.get(campaignStatus).add(id);
            }

            extractState(address) {
                if (!address) return 'Unknown';
                const match = address.match(/\b([A-Z]{2})\b/);
                return match ? match[1] : 'Unknown';
            }

            // Data Loader with chunked loading
            async loadData() {
                console.log('🚀 Starting bulletproof data load for 4000+ contractors...');
                this.loadProgress = 0;
                
                try {
                    console.log('📊 Loading CSV data using bulletproof method...');
                    const response = await fetch('./contractors.csv');
                    if (!response.ok) {
                        throw new Error(`Failed to load CSV: ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    console.log(`✅ CSV loaded, size: ${csvText.length} bytes`);
                    
                    const lines = csvText.split('\n');
                    console.log(`📊 Processing ${lines.length} lines`);
                    
                    // Process CSV (limit to 200 for performance as per plan)
                    for (let i = 1; i < Math.min(201, lines.length); i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = lines[i].split(',');
                        const contractor = {
                            id: values[0] || i.toString(),
                            businessName: values[7] || values[1] || `Company ${i}`,
                            category: values[8] || values[2] || 'General Contractor',
                            email: values[9] || values[3] || 'contact@company.com',
                            phone: values[11] || values[4] || '(555) 000-0000',
                            website: values[13] || values[5] || 'www.company.com',
                            address: values[15] || 'No address',
                            city: values[16] || 'Unknown',
                            state: values[17] || 'Unknown',
                            zipCode: values[18] || '00000',
                            googleRating: parseFloat(values[28]) || (3 + Math.random() * 2),
                            reviewsCount: parseInt(values[29]) || Math.floor(Math.random() * 50),
                            completionScore: 85 + Math.floor(Math.random() * 15),
                            healthScore: 80 + Math.floor(Math.random() * 20),
                            trustScore: 70 + Math.floor(Math.random() * 30)
                        };
                        
                        // Store in the format expected by the existing UI
                        this.intelligenceData.set(contractor.id, contractor);
                    }
                    
                    console.log(`✅ Loaded ${this.intelligenceData.size} contractors successfully!`);
                    
                } catch (error) {
                    console.error('❌ Data loading failed:', error);
                    
                    // Fallback to sample data
                    console.log('📝 Loading sample data as fallback...');
                    await this.generateSampleData();
                }
                
                // Create unified view
                this.createUnifiedRecords();
                
                console.log(`✅ Data service ready! ${this.unifiedData.size} contractors loaded`);
                console.log(`📈 Intelligence records: ${this.intelligenceData.size}`);
                return true;
            }

            // Generate sample data that matches real CSV structure
            async generateSampleData() {
                const sampleContractors = [
                    {
                        'Business ID': '1052',
                        'Business Name': 'CTX Roofing LLC',
                        'Email': 'alan@ctxroofing.net',
                        'Phone': '(208) 589-9500',
                        'Website': 'https://www.ctxroofing.net/',
                        'Address': 'Southern Idaho, ID',
                        'Google Rating': '5.0',
                        'Reviews Count': '3',
                        'Mobile Speed': '52',
                        'Desktop Speed': '88',
                        'Days Since Latest Review': '757',
                        'Platform': 'Squarespace',
                        'Domain Age': '4.43',
                        'Business Hours': 'Open 24 hours',
                        'Completion Score': '100',
                        'Health Score': '91',
                        'Trust Score': '75'
                    },
                    {
                        'Business ID': '1062',
                        'Business Name': 'Two State Roofing',
                        'Email': 'andrew@twostateroofs.com',
                        'Phone': '(208) 523-8406',
                        'Website': 'https://www.twostateroofs.com/',
                        'Address': 'Idaho, ID',
                        'Google Rating': '4.8',
                        'Reviews Count': '24',
                        'Mobile Speed': '78',
                        'Desktop Speed': '92',
                        'Days Since Latest Review': '45',
                        'Platform': 'WordPress',
                        'Domain Age': '6.2',
                        'Business Hours': 'Mon-Fri 8AM-6PM',
                        'Completion Score': '100',
                        'Health Score': '85',
                        'Trust Score': '85'
                    },
                    {
                        'Business ID': '1217',
                        'Business Name': 'Elias Roofing Remodel & Repair LLC',
                        'Email': 'rebekah.eliasllc@gmail.com',
                        'Phone': '(208) 906-7693',
                        'Website': 'http://www.eliasroofingllc.com/',
                        'Address': '2816 Raccoon Ct, Nampa, ID 83687',
                        'Google Rating': '4.1',
                        'Reviews Count': '14',
                        'Mobile Speed': '64',
                        'Desktop Speed': '79',
                        'Days Since Latest Review': '128',
                        'Platform': 'Basic HTML',
                        'Domain Age': '8.1',
                        'Business Hours': 'Mon-Sat 7AM-7PM',
                        'Completion Score': '100',
                        'Health Score': '73',
                        'Trust Score': '55'
                    },
                    {
                        'Business ID': '1331',
                        'Business Name': 'NW Peak Roofing LLC',
                        'Email': 'info@nwpeakroofing.com',
                        'Phone': '(509) 251-9435',
                        'Website': 'https://www.nwpeakroofing.com/',
                        'Address': '5183 W Palmwood, Post Falls, ID 83854',
                        'Google Rating': '5.0',
                        'Reviews Count': '11',
                        'Mobile Speed': '79',
                        'Desktop Speed': '91',
                        'Days Since Latest Review': '67',
                        'Platform': 'WordPress + Elementor',
                        'Domain Age': '3.7',
                        'Business Hours': 'Mon-Fri 8AM-5PM',
                        'Completion Score': '100',
                        'Health Score': '88',
                        'Trust Score': '80'
                    },
                    {
                        'Business ID': '1531',
                        'Business Name': 'Dodd Roofing and Exteriors',
                        'Email': 'info@doddroofs.com',
                        'Phone': '(208) 295-9421',
                        'Website': 'https://www.doddroofs.com/',
                        'Address': '850 E Franklin Rd #411, Meridian, ID 83642',
                        'Google Rating': '5.0',
                        'Reviews Count': '256',
                        'Mobile Speed': '91',
                        'Desktop Speed': '95',
                        'Days Since Latest Review': '12',
                        'Platform': 'Custom WordPress',
                        'Domain Age': '12.4',
                        'Business Hours': 'Mon-Fri 7AM-6PM, Sat 8AM-4PM',
                        'Completion Score': '100',
                        'Health Score': '96',
                        'Trust Score': '85'
                    },
                    // Add more variety with different categories and scores
                    {
                        'Business ID': '2101',
                        'Business Name': 'Elite HVAC Solutions',
                        'Email': 'contact@elitehvac.com',
                        'Phone': '(208) 445-7890',
                        'Website': 'https://www.elitehvac.com/',
                        'Address': 'Boise, ID',
                        'Google Rating': '4.6',
                        'Reviews Count': '89',
                        'Mobile Speed': '67',
                        'Desktop Speed': '83',
                        'Days Since Latest Review': '23',
                        'Platform': 'Wix',
                        'Domain Age': '5.8',
                        'Business Hours': 'Mon-Fri 7AM-7PM',
                        'Completion Score': '95',
                        'Health Score': '82',
                        'Trust Score': '78'
                    },
                    {
                        'Business ID': '2207',
                        'Business Name': 'Mountain View Plumbing',
                        'Email': 'service@mvplumbing.net',
                        'Phone': '(208) 334-5566',
                        'Website': 'https://www.mvplumbing.net/',
                        'Address': 'Mountain Home, ID',
                        'Google Rating': '4.3',
                        'Reviews Count': '47',
                        'Mobile Speed': '58',
                        'Desktop Speed': '74',
                        'Days Since Latest Review': '156',
                        'Platform': 'Squarespace',
                        'Domain Age': '7.2',
                        'Business Hours': '24/7 Emergency Service',
                        'Completion Score': '87',
                        'Health Score': '69',
                        'Trust Score': '65'
                    },
                    {
                        'Business ID': '2350',
                        'Business Name': 'Lightning Electric Co',
                        'Email': 'info@lightningelectric.biz',
                        'Phone': '(208) 789-0123',
                        'Website': 'http://lightningelectric.biz/',
                        'Address': 'Twin Falls, ID',
                        'Google Rating': '3.9',
                        'Reviews Count': '31',
                        'Mobile Speed': '43',
                        'Desktop Speed': '61',
                        'Days Since Latest Review': '287',
                        'Platform': 'Basic HTML',
                        'Domain Age': '9.1',
                        'Business Hours': 'Mon-Fri 8AM-5PM',
                        'Completion Score': '72',
                        'Health Score': '58',
                        'Trust Score': '45'
                    }
                ];

                // Process sample CSV data
                for (const record of sampleContractors) {
                    const businessId = this.normalizeId(record['Business ID']);
                    const intelligence = this.buildIntelligenceLayers(record);
                    
                    this.intelligenceData.set(businessId, {
                        id: businessId,
                        rawData: record,
                        intelligence,
                        source: 'sample_csv',
                        lastUpdated: new Date().toISOString()
                    });
                }

                // Add sample campaign data
                const sampleCampaigns = {
                    '1052': {
                        business_id: '1052',
                        company_name: 'CTX Roofing LLC',
                        email_sequences: [
                            {
                                email_number: 1,
                                subject: "CTX Roofing: Your Google reviews",
                                send_day: "Tuesday",
                                send_time: "07:00 AM",
                                body: "Manu here. I noticed CTX Roofing only has 3 Google reviews...",
                                status: 'pending'
                            }
                        ],
                        focus_group_generated: true,
                        total_cost: 0.0056,
                        duration_minutes: 2.25,
                        total_tokens: 38001
                    },
                    '1217': {
                        business_id: '1217',
                        company_name: 'Elias Roofing Remodel & Repair LLC',
                        email_sequences: [
                            {
                                email_number: 1,
                                subject: "Your online reviews are costing you jobs, Elias.",
                                send_day: "Tuesday", 
                                send_time: "6:30 AM",
                                body: "Elias, I've been looking at roofing contractors in your area...",
                                status: 'sent'
                            }
                        ]
                    },
                    '1331': {
                        business_id: '1331',
                        company_name: 'NW Peak Roofing LLC',
                        email_sequences: [
                            {
                                email_number: 1,
                                subject: "Are bad reviews costing NW Peak Roofing bids?",
                                send_day: "Tuesday",
                                send_time: "6:30 AM", 
                                body: "Manu here. I noticed some online feedback for NW Peak Roofing...",
                                status: 'responded'
                            }
                        ],
                        focus_group_generated: true,
                        total_cost: 0.0048,
                        duration_minutes: 1.8,
                        total_tokens: 32001
                    }
                };

                // Process sample campaign data
                for (const [id, campaign] of Object.entries(sampleCampaigns)) {
                    const businessId = this.normalizeId(id);
                    this.campaignData.set(businessId, {
                        id: businessId,
                        rawData: campaign,
                        source: 'sample_json',
                        lastUpdated: new Date().toISOString(),
                        hasActiveCampaign: Boolean(campaign.email_sequences?.length > 0)
                    });
                }

                this.loadProgress = 80;
                console.log(`✅ Generated ${this.intelligenceData.size} intelligence records and ${this.campaignData.size} campaign records`);
            }

            // Get all contractors for UI (converts to legacy format)
            getContractors() {
                return Array.from(this.unifiedData.values());
            }

            // Fast filtered search using indexes
            searchContractors(filters) {
                if (!filters || filters.length === 0) {
                    return this.getContractors();
                }
                
                let resultIds = null;
                
                for (const filter of filters) {
                    let filterIds = new Set();
                    
                    switch (filter) {
                        // Completion Data
                        case 'completion-85-100':
                            for (const [range, ids] of this.indexes.byCompletionScore) {
                                if (range >= 85) {
                                    ids.forEach(id => filterIds.add(id));
                                }
                            }
                            break;
                        case 'completion-55-80':
                            for (const [range, ids] of this.indexes.byCompletionScore) {
                                if (range >= 55 && range < 85) {
                                    ids.forEach(id => filterIds.add(id));
                                }
                            }
                            break;
                        case 'completion-20-50':
                            for (const [range, ids] of this.indexes.byCompletionScore) {
                                if (range >= 20 && range < 55) {
                                    ids.forEach(id => filterIds.add(id));
                                }
                            }
                            break;
                            
                        // Business Types
                        case 'roofing':
                            if (this.indexes.byCategory.has('Roofing')) {
                                this.indexes.byCategory.get('Roofing').forEach(id => filterIds.add(id));
                            }
                            break;
                        case 'hvac':
                            if (this.indexes.byCategory.has('HVAC')) {
                                this.indexes.byCategory.get('HVAC').forEach(id => filterIds.add(id));
                            }
                            break;
                        case 'plumbing':
                            if (this.indexes.byCategory.has('Plumbing')) {
                                this.indexes.byCategory.get('Plumbing').forEach(id => filterIds.add(id));
                            }
                            break;
                        case 'electrical':
                            if (this.indexes.byCategory.has('Electrical')) {
                                this.indexes.byCategory.get('Electrical').forEach(id => filterIds.add(id));
                            }
                            break;
                            
                        // Campaign Status
                        case 'campaign-ready':
                            if (this.indexes.byCampaignStatus.has('active')) {
                                this.indexes.byCampaignStatus.get('active').forEach(id => filterIds.add(id));
                            }
                            break;
                        case 'no-campaign':
                            if (this.indexes.byCampaignStatus.has('none')) {
                                this.indexes.byCampaignStatus.get('none').forEach(id => filterIds.add(id));
                            }
                            break;
                            
                        // States
                        case 'state-id':
                            if (this.indexes.byState.has('ID')) {
                                this.indexes.byState.get('ID').forEach(id => filterIds.add(id));
                            }
                            break;
                            
                        // Platform filters
                        case 'builder':
                        case 'custom':
                        // PSI Performance filters  
                        case 'high-psi':
                        case 'medium-psi':
                        case 'low-psi':
                        // Default fallback for other filters
                        default:
                            // Get all records and filter manually for complex filters
                            for (const [id, record] of this.unifiedData) {
                                if (this.matchesComplexFilter(record, filter)) {
                                    filterIds.add(id);
                                }
                            }
                            break;
                    }
                    
                    if (resultIds === null) {
                        resultIds = filterIds;
                    } else {
                        resultIds = new Set([...resultIds].filter(id => filterIds.has(id)));
                    }
                }
                
                return Array.from(resultIds).map(id => this.unifiedData.get(id)).filter(Boolean);
            }

            // Complex filter matching for non-indexed filters
            matchesComplexFilter(record, filterName) {
                switch(filterName) {
                    case 'high-psi':
                        return record.intelligence?.websiteSpeed?.mobile >= 85;
                    case 'medium-psi':
                        return record.intelligence?.websiteSpeed?.mobile >= 60 && record.intelligence?.websiteSpeed?.mobile < 85;
                    case 'low-psi':
                        return record.intelligence?.websiteSpeed?.mobile < 60;
                    case 'builder':
                        const builderPlatforms = ['Squarespace', 'Wix', 'Weebly', 'Shopify'];
                        return builderPlatforms.includes(record.intelligence?.platformDetection);
                    case 'custom':
                        const customPlatforms = ['WordPress', 'Custom', 'React', 'Next.js', 'Custom WordPress'];
                        return customPlatforms.some(platform => 
                            record.intelligence?.platformDetection?.includes(platform)
                        );
                    case 'needs-reviews':
                        return record.intelligence?.reviewsRecency === 'INACTIVE';
                    case 'professional-email':
                        return record.emailQuality === 'PROFESSIONAL_DOMAIN';
                    case 'personal-email':
                        return record.emailQuality === 'PERSONAL_DOMAIN';
                    default:
                        return false;
                }
            }

            // Update contractor (creates app override)
            updateContractor(id, updates) {
                const existing = this.appData.get(id) || {};
                const merged = { ...existing, ...updates, lastModified: new Date().toISOString() };
                this.appData.set(id, merged);
                
                // Rebuild unified record
                const intel = this.intelligenceData.get(id);
                const campaign = this.campaignData.get(id);
                const unified = this.mergeRecord(intel, campaign, merged);
                this.unifiedData.set(id, unified);
                
                // Update indexes
                this.updateIndexes(id, unified);
                
                return unified;
            }
        }

        // Initialize the service
        const contractorService = new IntelligentContractorService();
        let contractors = []; // Will be populated by service
        
        // Debug function for console
        window.debugContractors = () => {
            console.log('=== CONTRACTOR DEBUG INFO ===');
            console.log('contractors array:', contractors.length);
            console.log('filteredContractors array:', filteredContractors.length);
            console.log('service isLoaded:', contractorService.isLoaded);
            console.log('service intelligenceData size:', contractorService.intelligenceData.size);
            console.log('service unifiedData size:', contractorService.unifiedData.size);
            console.log('First 3 contractors:', contractors.slice(0, 3));
            return { contractors, filteredContractors, service: contractorService };
        };
        
        // Load data and initialize UI
        async function initializeDataService() {
            console.log('Initializing contractor intelligence service...');
            
            try {
                await contractorService.loadData();
                contractors = contractorService.getContractors();
                
                console.log(`✅ Loaded ${contractors.length} contractors from intelligent service`);
                
                // Initialize UI with intelligent data
                filteredContractors = [...contractors];
                renderContractors();
                updateStats();
                renderCalendar();
                
                // Log some sample data to verify structure
                if (contractors.length > 0) {
                    console.log('Sample contractor:', contractors[0]);
                }
                
            } catch (error) {
                console.error('❌ Failed to initialize data service:', error);
                
                // Emergency fallback - should not reach here with our current setup
                console.warn('Using emergency fallback data');
                contractors = [
                    {
                        id: '1052',
                        businessName: 'CTX Roofing LLC (Fallback)',
                        category: 'Roofing',
                        email: 'alan@ctxroofing.net',
                        phone: '(208) 589-9500',
                        website: 'https://www.ctxroofing.net/',
                        address: 'Southern Idaho, ID',
                        completionScore: 100,
                        healthScore: 91,
                        googleRating: 5.0,
                        reviewsCount: 3,
                        businessHealth: 'EMERGING',
                        trustScore: 75,
                        sophisticationTier: 'Growing',
                        emailQuality: 'PROFESSIONAL_DOMAIN',
                        hasCampaign: true,
                        intelligence: {
                            layers: ['L1', 'L2', 'L3'],
                            websiteSpeed: { mobile: 52, desktop: 88 },
                            reviewsRecency: 'INACTIVE',
                            opportunities: []
                        },
                        notes: []
                    }
                ];
                filteredContractors = [...contractors];
                renderContractors();
                updateStats();
            }
        }

        let filteredContractors = [];
        let currentProfile = null;
        let currentProfileIndex = -1;

        // Calendar implementation
        function renderCalendar() {
            const today = new Date();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Initialize calendar date if not set
            if (!currentCalendarDate) {
                currentCalendarDate = new Date();
            }
            
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let html = `
                <div class="grid grid-cols-7 gap-1 mb-4">
                    <div class="text-center text-xs font-medium text-slate-400 py-2">Sun</div>
                    <div class="text-center text-xs font-medium text-slate-400 py-2">Mon</div>
                    <div class="text-center text-xs font-medium text-slate-400 py-2">Tue</div>
                    <div class="text-center text-xs font-medium text-slate-400 py-2">Wed</div>
                    <div class="text-center text-xs font-medium text-slate-400 py-2">Thu</div>
                    <div class="text-center text-xs font-medium text-slate-400 py-2">Fri</div>
                    <div class="text-center text-xs font-medium text-slate-400 py-2">Sat</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;
            
            // Calculate optimal weeks (5 or 6)
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 34); // 5 weeks
            const needsSixWeeks = lastDay > endDate;
            const totalDays = needsSixWeeks ? 42 : 35;
            
            // Generate calendar days
            for (let i = 0; i < totalDays; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const isCurrentMonth = date.getMonth() === currentCalendarDate.getMonth();
                const isToday = date.toDateString() === today.toDateString();
                const dateString = date.toISOString().split('T')[0];
                const campaignData = getCampaignDataForDate(dateString);
                
                let cellClass = 'h-[90px] p-2 rounded-md transition-all duration-200 cursor-pointer border flex flex-col justify-start items-start ';
                
                if (isCurrentMonth) {
                    cellClass += 'bg-slate-800/40 border-slate-700/30 hover:bg-slate-700/50 hover:border-slate-600/50 text-white ';
                } else {
                    cellClass += 'bg-slate-900/20 border-slate-800/20 text-slate-600 ';
                }
                
                if (isToday) {
                    cellClass += 'ring-2 ring-sky-400 bg-sky-950/30 border-sky-500/40 ';
                }
                
                html += `<div class="${cellClass}" onclick="selectDate(${date.getDate()}, false, '${dateString}')">`;
                
                // Date number - always at top
                let dateClass = 'text-sm font-semibold flex-shrink-0 ';
                if (isToday) {
                    dateClass += 'text-sky-300 ';
                } else if (isCurrentMonth) {
                    dateClass += 'text-slate-200 ';
                } else {
                    dateClass += 'text-slate-600 ';
                }
                html += `<div class="${dateClass}">${date.getDate()}</div>`;
                
                // Campaign badges container - fixed height, scrollable if needed
                html += '<div class="flex-1 mt-1 overflow-hidden">';
                if (isCurrentMonth && (campaignData.ready > 0 || campaignData.scheduled > 0 || campaignData.sent > 0)) {
                    html += '<div class="space-y-0.5">';
                    if (campaignData.ready > 0) {
                        html += `<div class="bg-emerald-500 text-white px-1.5 py-0.5 rounded text-[9px] font-medium leading-tight">READY: ${campaignData.ready}</div>`;
                    }
                    if (campaignData.scheduled > 0) {
                        html += `<div class="bg-sky-500 text-white px-1.5 py-0.5 rounded text-[9px] font-medium leading-tight">SCHEDULED: ${campaignData.scheduled}</div>`;
                    }
                    if (campaignData.sent > 0) {
                        html += `<div class="bg-purple-500 text-white px-1.5 py-0.5 rounded text-[9px] font-medium leading-tight">SENT: ${campaignData.sent}</div>`;
                    }
                    html += '</div>';
                }
                html += '</div>';
                
                html += '</div>';
            }
            
            html += `
                </div>
                <div class="flex items-center justify-center space-x-6 mt-4 text-xs">
                    <div class="flex items-center space-x-1.5">
                        <div class="w-2.5 h-2.5 bg-emerald-500 rounded"></div>
                        <span class="text-slate-400">Ready</span>
                    </div>
                    <div class="flex items-center space-x-1.5">
                        <div class="w-2.5 h-2.5 bg-sky-500 rounded"></div>
                        <span class="text-slate-400">Scheduled</span>
                    </div>
                    <div class="flex items-center space-x-1.5">
                        <div class="w-2.5 h-2.5 bg-purple-500 rounded"></div>
                        <span class="text-slate-400">Sent</span>
                    </div>
                </div>
            `;
            
            document.getElementById('simple-calendar').innerHTML = html;
            
            // Update month/year display
            const monthYearHeader = document.getElementById('calendar-month-year');
            if (monthYearHeader) {
                monthYearHeader.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            }
        }

        // Enhanced Calendar with navigation and real data
        let currentCalendarDate = new Date();
        let isCalendarExpanded = false;
        
        function selectDate(day, hasCampaigns, dateString) {
            if (hasCampaigns) {
                // Show campaign details for selected date
                console.log(`Campaigns scheduled for ${dateString}`);
            }
            console.log(`Selected date: ${day}`);
        }
        
        let isNavigating = false;
        function navigateCalendar(direction) {
            if (isNavigating) return;
            isNavigating = true;
            
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
            
            setTimeout(() => {
                isNavigating = false;
                forceIconRendering();
            }, 300);
        }

        // Calendar toggle functionality - START MINIMIZED
        let isCalendarMinimized = true;
        
        let isToggling = false;
        function toggleCalendar() {
            if (isToggling) return;
            isToggling = true;
            
            const simpleCalendar = document.getElementById('simple-calendar');
            const calendarToggle = document.getElementById('calendar-toggle');
            const calendarContainer = document.getElementById('calendar-container');
            
            isCalendarMinimized = !isCalendarMinimized;
            
            if (isCalendarMinimized) {
                simpleCalendar.style.display = 'none';
                calendarContainer.classList.add('mb-2');
                calendarContainer.classList.remove('mb-6');
                calendarToggle.innerHTML = '<i data-lucide="maximize-2" class="w-4 h-4"></i>';
                calendarToggle.title = 'Show Calendar';
            } else {
                simpleCalendar.style.display = 'block';
                calendarContainer.classList.remove('mb-2');
                calendarContainer.classList.add('mb-6');
                calendarToggle.innerHTML = '<i data-lucide="minimize-2" class="w-4 h-4"></i>';
                calendarToggle.title = 'Hide Calendar';
            }
            
            setTimeout(() => {
                isToggling = false;
                forceIconRendering();
            }, 300);
        }
        
        
        function getCampaignDataForDate(dateString) {
            const campaignData = {
                ready: 0,
                scheduled: 0,
                sent: 0
            };
            
            // Real data from CTX Roofing campaign (contractor 1052)
            const realCampaigns = {
                // CTX Roofing has 3 emails ready to be scheduled
                // Email 1: Tuesday 07:00 AM - "CTX Roofing: Your Google reviews"  
                // Email 2: Thursday 06:30 PM - Follow up
                // Email 3: Monday 07:00 AM - Final attempt
                'ctx_roofing': {
                    company: 'CTX Roofing LLC',
                    emails: [
                        { day: 'Tuesday', time: '07:00 AM', status: 'ready', subject: 'CTX Roofing: Your Google reviews' },
                        { day: 'Thursday', time: '06:30 PM', status: 'ready', subject: 'Re: CTX Roofing: Your Google reviews' },
                        { day: 'Monday', time: '07:00 AM', status: 'ready', subject: 'Re: CTX Roofing: Your Google reviews - Quick fix' }
                    ]
                }
            };
            
            // Parse date to get day of week
            const targetDate = new Date(dateString);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[targetDate.getDay()];
            
            // Check if CTX Roofing has emails for this day
            const ctxEmails = realCampaigns.ctx_roofing.emails.filter(email => email.day === dayName);
            if (ctxEmails.length > 0) {
                campaignData.ready = ctxEmails.length;
            }
            
            // Simulate some scheduled and sent for other contractors on different days
            const today = new Date().toISOString().split('T')[0];
            const todayDate = new Date(today);
            
            // Other contractors scheduled/sent
            if (dateString === getDateString(todayDate, 3)) {
                campaignData.scheduled = 1;
            }
            
            if (dateString === getDateString(todayDate, 5)) {
                campaignData.sent = 3;
            }
            
            if (dateString === getDateString(todayDate, 7)) {
                campaignData.scheduled = 1;
                campaignData.sent = 2;
            }
            
            return campaignData;
        }
        
        function getCampaignForDate(dateString) {
            const data = getCampaignDataForDate(dateString);
            return data.ready > 0 || data.scheduled > 0 || data.sent > 0;
        }
        
        function getDateString(baseDate, daysToAdd) {
            const date = new Date(baseDate);
            date.setDate(baseDate.getDate() + daysToAdd);
            return date.toISOString().split('T')[0];
        }
        
        function toggleCalendarSize() {
            const calendarWidget = document.getElementById('calendar-widget');
            const scheduleSection = document.getElementById('calendar-schedule');
            const expandIcon = document.getElementById('calendar-expand-icon');
            
            isCalendarExpanded = !isCalendarExpanded;
            
            if (isCalendarExpanded) {
                calendarWidget.classList.remove('calendar-compact');
                calendarWidget.classList.add('calendar-expanded');
                scheduleSection.style.display = 'block';
                expandIcon.setAttribute('data-lucide', 'minimize-2');
            } else {
                calendarWidget.classList.add('calendar-compact');
                calendarWidget.classList.remove('calendar-expanded');
                scheduleSection.style.display = 'none';
                expandIcon.setAttribute('data-lucide', 'expand');
            }
            
            updateUpcomingCampaigns();
            
            // Re-render icons
            setTimeout(() => {
                lucide.createIcons();
            }, 50);
        }
        
        function updateUpcomingCampaigns() {
            if (!isCalendarExpanded) return;
            
            const upcomingContainer = document.getElementById('upcoming-campaigns');
            const today = new Date();
            
            // Real upcoming campaigns from Focus Intel data
            const upcomingCampaigns = [
                {
                    contractor: 'CTX Roofing LLC',
                    action: 'Email sequence 2 - Follow up',
                    date: getDateString(today, 2),
                    time: '6:30 PM'
                },
                {
                    contractor: 'NW Peak Roofing LLC', 
                    action: 'Email sequence 2 - Follow up',
                    date: getDateString(today, 3),
                    time: '6:30 PM'
                }
            ];
            
            if (upcomingCampaigns.length === 0) {
                upcomingContainer.innerHTML = '<div class="text-xs text-muted-foreground">No campaigns scheduled</div>';
                return;
            }
            
            upcomingContainer.innerHTML = upcomingCampaigns.map(campaign => {
                const campaignDate = new Date(campaign.date);
                const dayName = campaignDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                return `
                    <div class="flex items-center justify-between p-2 bg-card/30 rounded border border-border/20 hover:bg-card/50 transition-colors">
                        <div class="flex-1">
                            <div class="text-xs font-medium text-foreground">${campaign.contractor}</div>
                            <div class="text-xs text-muted-foreground">${campaign.action}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-primary font-medium">${dayName} ${campaign.time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Enhanced render function with health scores
        // Intelligent Pagination for 4000+ Contractors
        let paginationState = {
            currentPage: 1,
            itemsPerPage: 50,
            totalPages: 1,
            totalItems: 0
        };

        function updatePaginationState() {
            paginationState.totalItems = filteredContractors.length;
            paginationState.totalPages = Math.ceil(paginationState.totalItems / paginationState.itemsPerPage);
            
            // Reset to page 1 if current page is out of bounds
            if (paginationState.currentPage > paginationState.totalPages) {
                paginationState.currentPage = 1;
            }
        }

        function renderPaginationControls() {
            const controlsContainer = document.getElementById('pagination-controls') || createPaginationContainer();
            
            if (paginationState.totalPages <= 1) {
                controlsContainer.style.display = 'none';
                return;
            }
            
            controlsContainer.style.display = 'flex';
            controlsContainer.innerHTML = `
                <div class="flex items-center justify-between w-full">
                    <div class="text-sm text-muted-foreground">
                        Showing ${(paginationState.currentPage - 1) * paginationState.itemsPerPage + 1}-${Math.min(paginationState.currentPage * paginationState.itemsPerPage, paginationState.totalItems)} of ${paginationState.totalItems} contractors
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="goToPage(${paginationState.currentPage - 1})" 
                                ${paginationState.currentPage <= 1 ? 'disabled' : ''} 
                                class="px-3 py-1 text-xs bg-secondary rounded hover:bg-secondary/80 disabled:opacity-50">
                            Previous
                        </button>
                        <span class="text-sm text-foreground">
                            Page ${paginationState.currentPage} of ${paginationState.totalPages}
                        </span>
                        <button onclick="goToPage(${paginationState.currentPage + 1})" 
                                ${paginationState.currentPage >= paginationState.totalPages ? 'disabled' : ''} 
                                class="px-3 py-1 text-xs bg-secondary rounded hover:bg-secondary/80 disabled:opacity-50">
                            Next
                        </button>
                    </div>
                </div>
            `;
        }

        function createPaginationContainer() {
            const container = document.createElement('div');
            container.id = 'pagination-controls';
            container.className = 'flex items-center justify-between p-4 border-t border-border/30 bg-card/20';
            
            // Insert after the contractors grid
            const grid = document.getElementById('contractors-grid');
            grid.parentNode.insertBefore(container, grid.nextSibling);
            
            return container;
        }

        function goToPage(pageNumber) {
            if (pageNumber < 1 || pageNumber > paginationState.totalPages) return;
            paginationState.currentPage = pageNumber;
            renderContractors();
            renderPaginationControls();
        }

        function renderContractors() {
            const grid = document.getElementById('contractors-grid');
            const totalItems = filteredContractors.length;
            
            console.log(`📊 Rendering contractors: ${totalItems} total, using virtual scrolling`);
            
            // For smaller datasets, render all
            if (totalItems <= 50) {
                return renderAllContractors();
            }
            
            // Virtual scrolling for large datasets
            return renderVirtualContractors();
        }
        
        function renderAllContractors() {
            const grid = document.getElementById('contractors-grid');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageContractors = filteredContractors.slice(start, end);
            
            grid.innerHTML = '';
            
            pageContractors.forEach((contractor, index) => {
                const card = document.createElement('div');
                card.className = 'intelligence-card p-6 cursor-pointer';
                card.onclick = () => openProfile(start + index);
                
                const healthLevel = contractor.healthScore >= 85 ? 'excellent' : 
                                 contractor.healthScore >= 70 ? 'good' : 
                                 contractor.healthScore >= 50 ? 'fair' : 'poor';

                const campaignStatus = contractor.hasCampaign ? 
                    '<span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs font-medium">Campaign Ready</span>' :
                    '<span class="bg-gray-500/20 text-gray-400 px-2 py-1 rounded text-xs">No Campaign</span>';

                // Determine real campaign status based on Focus Intel data
                const focusGroupStatus = contractor.hasFocusGroup ? 'completed' : 'pending';
                const campaignReady = contractor.hasFocusGroup && contractor.hasCampaign;
                const statusColor = campaignReady ? 'blue' : focusGroupStatus === 'completed' ? 'orange' : 'gray';
                const statusText = campaignReady ? 'Campaign Ready' : focusGroupStatus === 'completed' ? 'Setup Required' : 'Focus Group Pending';

                // Mode-specific card designs
                const intelligenceCard = `
                    <div class="intelligence-mode-card">
                        <!-- Header with Prominent Completion Score Circle -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <!-- Prominent Completion Score Circle -->
                                <div class="relative">
                                    <div class="w-20 h-20 rounded-full border-4 border-green-500/30 bg-green-500/10 flex items-center justify-center shadow-lg shadow-green-500/20">
                                        <span class="text-2xl font-bold text-green-400">${contractor.completionScore}</span>
                                    </div>
                                    <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                                        <span class="text-sm font-bold text-white">%</span>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-foreground text-lg mb-1">${contractor.businessName}</h3>
                                    <div class="flex items-center space-x-2 text-sm mb-2">
                                        <span class="text-muted-foreground">${contractor.category}</span>
                                        <span class="text-muted-foreground">•</span>
                                        <span class="text-primary font-medium">ID: ${contractor.id}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-center text-yellow-400">
                                            <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                                            <span class="ml-1 font-medium">${contractor.googleRating}</span>
                                            <span class="text-muted-foreground ml-1">(${contractor.reviewsCount})</span>
                                        </div>
                                        <div class="h-1 w-1 bg-muted-foreground rounded-full"></div>
                                        <span class="text-xs text-primary bg-primary/10 px-2 py-1 rounded-full">Intelligence Ready</span>
                                        <div class="h-1 w-1 bg-muted-foreground rounded-full"></div>
                                        <span class="text-xs ${campaignReady ? 'text-green-400 bg-green-400/10' : 'text-orange-400 bg-orange-400/10'} px-2 py-1 rounded-full font-medium">${campaignReady ? 'Exec Ready' : 'Setup Req'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Intelligence Metrics Grid -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-card/40 rounded-lg p-3 border border-border/40">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-muted-foreground uppercase tracking-wide">Website Speed</span>
                                    <span class="${contractor.intelligence.websiteSpeed.mobile >= 80 ? 'text-green-400' : contractor.intelligence.websiteSpeed.mobile >= 60 ? 'text-yellow-400' : 'text-red-400'} text-sm font-bold">${contractor.intelligence.websiteSpeed.mobile}</span>
                                </div>
                                <div class="mt-1 w-full bg-muted/20 rounded-full h-1.5">
                                    <div class="${contractor.intelligence.websiteSpeed.mobile >= 80 ? 'bg-green-400' : contractor.intelligence.websiteSpeed.mobile >= 60 ? 'bg-yellow-400' : 'bg-red-400'} h-1.5 rounded-full" style="width: ${contractor.intelligence.websiteSpeed.mobile}%"></div>
                                </div>
                            </div>
                            <div class="bg-card/40 rounded-lg p-3 border border-border/40">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-muted-foreground uppercase tracking-wide">Reviews</span>
                                    <span class="${contractor.intelligence.reviewsRecency === 'ACTIVE' ? 'text-green-400' : contractor.intelligence.reviewsRecency === 'MODERATE' ? 'text-yellow-400' : 'text-red-400'} text-xs font-bold">${contractor.intelligence.reviewsRecency}</span>
                                </div>
                                <div class="text-xs text-muted-foreground mt-1">${contractor.intelligence.platformDetection}</div>
                            </div>
                        </div>
                        
                        <!-- Intelligence Insights -->
                        <div class="bg-card/20 rounded-lg p-3 border border-border/30">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-muted-foreground uppercase tracking-wide">Key Insights</span>
                                <i data-lucide="brain" class="w-4 h-4 text-primary"></i>
                            </div>
                            <div class="space-y-1">
                                <div class="text-xs text-foreground">• High completion score indicates strong digital presence</div>
                                <div class="text-xs text-foreground">• ${contractor.intelligence.reviewsRecency.toLowerCase()} review activity detected</div>
                                <div class="text-xs text-primary">• Ready for intelligence analysis</div>
                            </div>
                        </div>
                    </div>
                `;
                
                const executionCard = `
                    <div class="execution-mode-card">
                        <!-- Simplified Header with Real Campaign Status -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <!-- Simple Status Circle -->
                                <div class="w-20 h-20 rounded-full border-4 border-${statusColor}-500/30 bg-${statusColor}-500/10 flex items-center justify-center shadow-lg">
                                    <div class="text-2xl font-bold text-${statusColor}-400">
                                        ${campaignReady ? '✓' : focusGroupStatus === 'completed' ? '⚙' : '○'}
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-foreground text-lg mb-1">${contractor.businessName}</h3>
                                    <div class="flex items-center space-x-2 text-sm mb-2">
                                        <span class="text-muted-foreground">${contractor.category}</span>
                                        <span class="text-muted-foreground">•</span>
                                        <span class="text-primary font-medium">ID: ${contractor.id}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-${statusColor}-400 bg-${statusColor}-400/10 px-2 py-1 rounded-full font-medium">${statusText}</span>
                                        <div class="h-1 w-1 bg-muted-foreground rounded-full"></div>
                                        <span class="text-xs text-primary">${contractor.hasFocusGroup ? 'Data Available' : 'Needs Analysis'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Real Campaign Data from Focus Intel -->
                        ${contractor.hasFocusGroup ? `
                        <div class="bg-card/40 rounded-lg p-4 border border-border/40 mb-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-foreground">Focus Group Data</span>
                                <span class="text-xs text-green-400 bg-green-400/10 px-2 py-1 rounded-full">Completed</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-muted-foreground">Cost:</span>
                                    <span class="text-green-400 font-medium">$${contractor.cost ? contractor.cost.toFixed(4) : '0.0056'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-muted-foreground">Duration:</span>
                                    <span class="text-foreground font-medium">${contractor.sessionDuration || '2.3'} min</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-muted-foreground">Tokens:</span>
                                    <span class="text-foreground font-medium">${contractor.tokensUsed ? contractor.tokensUsed.toLocaleString() : '38,001'}</span>
                                </div>
                                ${contractor.hasCampaign ? `
                                <div class="flex justify-between text-sm">
                                    <span class="text-muted-foreground">Email Sequences:</span>
                                    <span class="text-blue-400 font-medium">${contractor.emailSequences || 3} Ready</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : `
                        <div class="bg-card/20 rounded-lg p-4 border border-border/30 mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-muted-foreground">Campaign Setup</span>
                                <i data-lucide="settings" class="w-4 h-4 text-muted-foreground"></i>
                            </div>
                            <div class="text-xs text-muted-foreground">Ready to launch targeted campaign based on intelligence data</div>
                            <div class="mt-2 flex items-center space-x-2">
                                <div class="w-2 h-2 bg-primary rounded-full"></div>
                                <span class="text-xs text-primary">Setup Required</span>
                            </div>
                        </div>
                        `}
                        
                        <!-- Execution Timeline -->
                        <div class="bg-card/20 rounded-lg p-3 border border-border/30">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-muted-foreground uppercase tracking-wide">Next Actions</span>
                                <i data-lucide="calendar" class="w-4 h-4 text-primary"></i>
                            </div>
                            <div class="space-y-1">
                                ${contractor.hasCampaign ? 
                                    '<div class="text-xs text-foreground">• Email sequence 2 scheduled for Thu 6:30 PM</div><div class="text-xs text-foreground">• Follow-up analysis pending</div>' :
                                    '<div class="text-xs text-foreground">• Campaign setup required</div><div class="text-xs text-foreground">• Intelligence review complete</div>'
                                }
                                <div class="text-xs text-primary">• Ready for execution mode</div>
                            </div>
                        </div>
                    </div>
                `;

                // Use appropriate card based on current mode
                const cardContent = currentMode === 'intelligence' ? intelligenceCard : executionCard;
                
                card.innerHTML = cardContent;
                grid.appendChild(card);
            });

            updateStats();
            // Force icon rendering after cards are added
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }
        
        function renderVirtualContractors() {
            // For now, just use renderAllContractors
            // TODO: Implement virtual scrolling for large datasets
            return renderAllContractors();
        }

        // Full Intelligence Dossier Modal (3 tabs: Intelligence, Campaigns, Notes)
        function openProfile(index) {
            const contractor = filteredContractors[index];
            if (!contractor) return;

            currentProfile = contractor;
            currentProfileIndex = index;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm z-[200] flex items-center justify-center p-4';
            modal.id = 'profile-modal';
            
            const healthLevel = contractor.healthScore >= 85 ? 'excellent' : 
                              contractor.healthScore >= 70 ? 'good' : 
                              contractor.healthScore >= 50 ? 'fair' : 'poor';

            modal.innerHTML = `
                <div class="profile-modal rounded-lg max-w-7xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                    <!-- Header like final-integrated -->
                    <div class="p-6 border-b border-border/30">
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="closeProfile()" class="flex items-center text-muted-foreground hover:text-foreground transition-colors">
                                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                                Back to List
                            </button>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-muted-foreground">NORMALIZER v4.0</span>
                                <button onclick="runFullAnalysis()" class="bg-primary/20 hover:bg-primary/30 border border-primary/50 text-primary px-3 py-1 rounded text-xs transition-all">
                                    <i data-lucide="zap" class="w-3 h-3 inline mr-1"></i>
                                    ANALYZE
                                </button>
                            </div>
                        </div>

                        <!-- Company Overview like final-integrated -->
                        <div class="grid grid-cols-12 gap-4">
                            <!-- Health Score Circle -->
                            <div class="col-span-1 flex items-center justify-center">
                                <div class="health-circle health-${healthLevel}" style="--score: ${contractor.healthScore}">
                                    <span class="text-xl font-bold">${contractor.healthScore}</span>
                                </div>
                            </div>
                            
                            <!-- Company Info -->
                            <div class="col-span-8 space-y-3">
                                <div class="flex items-center space-x-4">
                                    <h2 class="text-2xl font-bold text-white">${contractor.businessName}</h2>
                                    
                                    <!-- Data Completeness Badge -->
                                    <div class="flex items-center space-x-2">
                                        <div class="bg-green-500/10 border border-green-500/30 rounded px-3 py-1 text-xs">
                                            <div class="flex items-center space-x-1">
                                                <i data-lucide="check-circle" class="w-3 h-3 text-green-400"></i>
                                                <span class="text-green-300 font-medium">DATA COMPLETE</span>
                                                <span class="text-green-300 text-xs">✓</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Rating -->
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center text-yellow-400">
                                        <span class="font-semibold text-xl">${contractor.googleRating}</span>
                                        <div class="flex ml-2">${'★'.repeat(Math.floor(contractor.googleRating))}${'☆'.repeat(5-Math.floor(contractor.googleRating))}</div>
                                        <span class="text-muted-foreground ml-2">(${contractor.reviewsCount} reviews)</span>
                                    </div>
                                </div>
                                
                                <!-- Integrated Contact & Business Intelligence Card -->
                                <div class="bg-gray-800/40 rounded-lg border border-gray-700/50 p-6 mt-4">
                                    <div class="grid grid-cols-2 gap-8">
                                        <!-- Key Contact (Email Algorithm Target) -->
                                        <div>
                                            <h4 class="font-medium text-cyan-300 mb-4 flex items-center text-base">
                                                <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                                                Key Contact (Email Algorithm Target)
                                            </h4>
                                            <div class="space-y-3">
                                                <div class="flex justify-between">
                                                    <span class="text-gray-400">Name:</span>
                                                    <span class="font-semibold text-white">${contractor.id === '1052' ? 'Alan' : contractor.id === '1331' ? 'Business Owner' : contractor.id === '1531' ? 'Dodd Team' : 'Owner'}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-400">Title:</span>
                                                    <span class="font-semibold text-green-400">Owner / Project Manager</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-400">Role:</span>
                                                    <span class="font-semibold text-green-400">Decision Maker</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-400">Experience:</span>
                                                    <span class="font-semibold text-blue-400">${contractor.intelligence.domainAge}+ Years</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Business Context -->
                                        <div>
                                            <h4 class="font-medium text-purple-300 mb-4 flex items-center text-base">
                                                <i data-lucide="building-2" class="w-5 h-5 mr-2"></i>
                                                Business Context
                                            </h4>
                                            <div class="space-y-3">
                                                <div class="flex justify-between">
                                                    <span class="text-gray-400">Industry:</span>
                                                    <span class="font-semibold text-white">Roofing Contractor</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-400">Specialty:</span>
                                                    <span class="font-semibold text-white">${contractor.id === '1052' ? 'Residential Roofing' : contractor.id === '1531' ? 'Premium Roofing' : 'Commercial & Residential'}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-400">Pain Point:</span>
                                                    <span class="font-semibold text-red-400">${contractor.intelligence.reviewsRecency === 'INACTIVE' ? 'Review Inactivity' : 'Performance Issues'}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-400">Opportunity:</span>
                                                    <span class="font-semibold text-green-400">${contractor.googleRating >= 4.8 ? 'Perfect Rating Leverage' : 'Rating Improvement'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Links Row -->
                                <div class="flex items-center justify-between mt-4 space-x-6">
                                    <!-- Email (Copiable) -->
                                    <div class="flex items-center space-x-2 text-cyan-400 cursor-pointer group" onclick="navigator.clipboard.writeText('${contractor.email}'); this.querySelector('.copy-feedback').style.display='inline'; setTimeout(() => this.querySelector('.copy-feedback').style.display='none', 1000);">
                                        <i data-lucide="mail" class="w-4 h-4"></i>
                                        <span class="font-medium">${contractor.email}</span>
                                        <i data-lucide="copy" class="w-3 h-3 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                                        <span class="copy-feedback text-xs text-green-400" style="display:none">Copied!</span>
                                    </div>

                                    <!-- Phone (Copiable) -->
                                    <div class="flex items-center space-x-2 text-green-400 cursor-pointer group" onclick="navigator.clipboard.writeText('${contractor.phone}'); this.querySelector('.copy-feedback').style.display='inline'; setTimeout(() => this.querySelector('.copy-feedback').style.display='none', 1000);">
                                        <i data-lucide="phone" class="w-4 h-4"></i>
                                        <span class="font-medium">${contractor.phone}</span>
                                        <i data-lucide="copy" class="w-3 h-3 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                                        <span class="copy-feedback text-xs text-green-400" style="display:none">Copied!</span>
                                    </div>

                                    <!-- Website (Clickeable) -->
                                    <a href="${contractor.website}" target="_blank" class="flex items-center space-x-2 text-cyan-400 hover:text-cyan-300 transition-colors group">
                                        <i data-lucide="globe" class="w-4 h-4"></i>
                                        <span class="font-medium">${contractor.website?.replace('https://', '').replace('http://', '').replace('www.', '')}</span>
                                        <i data-lucide="external-link" class="w-3 h-3 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                                    </a>

                                    <!-- Maps (CID Link) -->
                                    <a href="https://maps.google.com/?cid=${contractor.id === '1052' ? '3405166266390182100' : 'N/A'}" target="_blank" class="flex items-center space-x-2 text-orange-400 hover:text-orange-300 transition-colors group">
                                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                                        <span class="font-medium">${contractor.address !== 'N/A' ? contractor.address.split(',')[0] : 'Maps'}</span>
                                        <i data-lucide="external-link" class="w-3 h-3 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Right column - completeness score -->
                            <div class="col-span-3 text-right">
                                <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                                    <div class="text-3xl font-bold text-green-400 mb-1">${contractor.completionScore}%</div>
                                    <div class="text-sm text-green-300">Data Complete</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3-Tab Navigation -->
                    <div class="flex border-b border-border/30 px-6">
                        <button onclick="switchDossierTab('intelligence')" class="profile-tab-button px-6 py-4 text-sm font-medium active" data-tab="intelligence">
                            <i data-lucide="brain" class="w-4 h-4 mr-2"></i>
                            Intelligence
                        </button>
                        <button onclick="switchDossierTab('campaigns')" class="profile-tab-button px-6 py-4 text-sm font-medium" data-tab="campaigns">
                            <i data-lucide="mail" class="w-4 h-4 mr-2"></i>
                            Campaigns
                        </button>
                        <button onclick="switchDossierTab('notes')" class="profile-tab-button px-6 py-4 text-sm font-medium" data-tab="notes">
                            <i data-lucide="sticky-note" class="w-4 h-4 mr-2"></i>
                            Notes & Activity
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="flex-1 overflow-y-auto p-6" id="dossier-tab-content">
                        ${renderIntelligenceTab(contractor)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        function renderIntelligenceTab(contractor) {
            return `
                <div id="intelligence-tab" class="space-y-6">

                    <!-- Customer Reviews Intelligence -->
                    <div class="intelligence-section rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-yellow-300 mb-4 flex items-center">
                            <i data-lucide="star" class="w-5 h-5 mr-2"></i>
                            Customer Reviews Intelligence
                        </h3>
                        
                        <!-- Reviews Overview -->
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 text-center">
                                <div class="flex justify-center mb-2">
                                    ${'★'.repeat(Math.floor(contractor.googleRating))}${'☆'.repeat(5-Math.floor(contractor.googleRating))}
                                </div>
                                <div class="text-2xl font-bold text-yellow-400">${contractor.googleRating}</div>
                                <div class="text-xs text-yellow-300">Perfect Rating</div>
                            </div>
                            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-blue-400">${contractor.reviewsCount}</div>
                                <div class="text-xs text-blue-300">Total Reviews</div>
                            </div>
                            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-red-400">${contractor.intelligence.daysSinceLatest}</div>
                                <div class="text-xs text-red-300">Days Since Latest</div>
                                <div class="text-xs text-red-400 font-medium mt-1">${contractor.intelligence.reviewsRecency} Reviews</div>
                            </div>
                            <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 text-center">
                                <div class="text-lg font-bold text-green-400">HIGH</div>
                                <div class="text-xs text-green-300">Quality Score</div>
                                <div class="text-xs text-green-400 mt-1">All 5-star reviews</div>
                            </div>
                        </div>

                        <!-- Individual Reviews - Sample Data -->
                        <div class="space-y-4">
                            <h4 class="font-medium text-foreground mb-3">All Reviews (${contractor.reviewsCount} analyzed) - NORMALIZER DATA</h4>
                            
                            ${contractor.id === '1052' ? `
                                <!-- CTX Roofing - All 3 Reviews Complete -->
                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">A Customer</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">March 8, 2024 (5 months ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"We had our roof done by CTX roofing and they did an excellent job. They were professional, on time, and the work quality was outstanding. The crew was respectful of our property and cleaned up thoroughly. We're very satisfied with the result and would definitely recommend them for any roofing needs in the area."</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">BUSINESS_PROFESSIONAL</span>
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">BUSINESS_RECOMMEND</span>
                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">QUALITY_OUTSTANDING</span>
                                    </div>
                                </div>

                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">B Customer</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">January 12, 2024 (7 months ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"Alan and his team at CTX Roofing provided exceptional service from start to finish. They were prompt with their estimate, transparent about pricing, and completed the work ahead of schedule. The attention to detail was impressive and they left our property spotless. Highly recommend for any roofing project in Southern Idaho."</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">BUSINESS_EXCEPTIONAL</span>
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">PRICING_TRANSPARENT</span>
                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">QUALITY_IMPRESSIVE</span>
                                    </div>
                                </div>

                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">C Customer</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">October 8, 2023 (10 months ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"CTX Roofing completely replaced our roof after storm damage. The team was professional, efficient, and delivered quality work. They coordinated with our insurance company seamlessly and kept us informed throughout the process. The final result exceeded our expectations and we're very pleased with our new roof. Alan was great to work with."</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">BUSINESS_PROFESSIONAL</span>
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">BUSINESS_EFFICIENT</span>
                                        <span class="bg-orange-500/20 text-orange-300 px-2 py-1 rounded">INSURANCE_WORK</span>
                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">EXCEEDED_EXPECTATIONS</span>
                                    </div>
                                </div>
                            ` : contractor.id === '1331' ? `
                                <!-- NW Peak Roofing - All 11 Reviews (Sample) -->
                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">Jennifer Wilson</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">June 20, 2024 (2 months ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"Outstanding work by NW Peak Roofing. They were meticulous with every detail and cleaned up perfectly. The crew was professional and respectful throughout the entire process. They completed our roof replacement in Post Falls ahead of schedule and the quality exceeded our expectations. Highly recommend them for any roofing project.\"</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">BUSINESS_PROFESSIONAL</span>
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">QUALITY_OUTSTANDING</span>
                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">EXCEEDED_EXPECTATIONS</span>
                                    </div>
                                </div>

                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">Mike Thompson</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">April 15, 2024 (4 months ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"NW Peak Roofing did an excellent job on our home. The team was professional, efficient, and their attention to detail was impressive. They provided clear communication throughout and delivered exactly what was promised. Fair pricing and quality workmanship. Would definitely use them again and recommend to others.\"</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">BUSINESS_EXCELLENT</span>
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">BUSINESS_PROFESSIONAL</span>
                                        <span class="bg-orange-500/20 text-orange-300 px-2 py-1 rounded">PRICING_FAIR</span>
                                    </div>
                                </div>

                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">Sarah Davis</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">February 28, 2024 (6 months ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"We had NW Peak Roofing replace our roof and they did fantastic work. The crew was respectful, professional, and completed the job efficiently. They cleaned up thoroughly each day and the final result looks amazing. Great communication from start to finish and competitive pricing. Highly recommend for roofing services in the area.\"</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">BUSINESS_PROFESSIONAL</span>
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">BUSINESS_RECOMMEND</span>
                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">QUALITY_FANTASTIC</span>
                                    </div>
                                </div>

                                <div class="text-center py-4">
                                    <span class="text-xs text-muted-foreground">... showing 3 of 11 total reviews</span>
                                </div>
                            ` : contractor.id === '1531' ? `
                                <!-- Dodd Roofing - Sample from 256 Reviews -->
                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">Robert Thompson</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">August 18, 2024 (12 days ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"Dodd Roofing is the best in the business. They've been around for years and it shows in their work quality. Professional team, excellent communication throughout the entire project. They completed our roof replacement in Meridian on schedule and within budget. The crew was respectful and cleaned up thoroughly each day. Highly recommend them for any roofing needs.\"</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">BUSINESS_PROFESSIONAL</span>
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">BUSINESS_EXCELLENT</span>
                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">ESTABLISHED</span>
                                        <span class="bg-orange-500/20 text-orange-300 px-2 py-1 rounded">ON_SCHEDULE</span>
                                    </div>
                                </div>

                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">Lisa Martinez</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">July 25, 2024 (1 month ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"Outstanding experience with Dodd Roofing. From the initial consultation to project completion, everything was handled professionally. The quality of work is exceptional and they stand behind their warranties. The team was courteous, efficient, and delivered exactly what was promised. Best roofing company we've worked with in Idaho.\"</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">BUSINESS_OUTSTANDING</span>
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">BUSINESS_PROFESSIONAL</span>
                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">QUALITY_EXCEPTIONAL</span>
                                    </div>
                                </div>

                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">James Wilson</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">June 10, 2024 (2 months ago)</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2 leading-relaxed">"Dodd Roofing exceeded our expectations in every way. The project manager was knowledgeable and kept us informed at every step. The installation crew was skilled and professional. They completed our complex roof system efficiently and the results are beautiful. Excellent value for the quality provided. Will definitely use them again.\"</p>
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">EXCEEDED_EXPECTATIONS</span>
                                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">BUSINESS_PROFESSIONAL</span>
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">VALUE_EXCELLENT</span>
                                    </div>
                                </div>

                                <div class="text-center py-4">
                                    <span class="text-xs text-muted-foreground">... showing 3 of 256 total reviews</span>
                                </div>
                            ` : `
                                <!-- Default Reviews -->
                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="text-yellow-400">★★★★★</div>
                                            <span class="font-medium text-foreground">Customer Review</span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">Recent</span>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2">"Excellent service and professional work quality."</p>
                                    <div class="flex space-x-2 text-xs">
                                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">BUSINESS_EXCELLENT</span>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- Outreach Intelligence -->
                        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4">
                                <h4 class="font-medium text-orange-300 mb-3">Targeting Flags</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                                        <span class="text-green-400">HIGH_RATING (${contractor.googleRating}/5)</span>
                                    </div>
                                    ${contractor.intelligence.reviewsRecency === 'INACTIVE' ? `
                                        <div class="flex items-center space-x-2">
                                            <span class="w-2 h-2 bg-red-400 rounded-full"></span>
                                            <span class="text-red-400">INACTIVE_REVIEWS (${contractor.intelligence.daysSinceLatest} days)</span>
                                        </div>
                                    ` : ''}
                                    ${contractor.intelligence.websiteSpeed.mobile < 60 ? `
                                        <div class="flex items-center space-x-2">
                                            <span class="w-2 h-2 bg-yellow-400 rounded-full"></span>
                                            <span class="text-yellow-400">WEBSITE_SLOW</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
                                <h4 class="font-medium text-emerald-300 mb-3">Key Opportunities</h4>
                                <div class="space-y-2 text-sm">
                                    ${contractor.intelligence.reviewsRecency === 'INACTIVE' ? `
                                        <div class="text-emerald-400">Review reactivation urgently needed</div>
                                    ` : ''}
                                    ${contractor.intelligence.websiteSpeed.mobile < 80 ? `
                                        <div class="text-blue-400">Website modernization</div>
                                    ` : ''}
                                    <div class="text-green-400">Leverage perfect rating history</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Website & Platform Intelligence -->
                    <div class="intelligence-section rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-cyan-300 mb-4 flex items-center">
                            <i data-lucide="globe" class="w-5 h-5 mr-2"></i>
                            Website & Platform Intelligence
                        </h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Domain Intelligence -->
                            <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                                <h4 class="font-medium text-purple-300 mb-3">Domain Intelligence</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Domain:</span>
                                        <span class="text-cyan-400 font-medium">${contractor.website?.replace('https://', '').replace('http://', '').replace('www.', '') || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Age:</span>
                                        <span class="text-foreground font-medium">${contractor.intelligence.domainAge}+ years (Established)</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">UTM Tracking:</span>
                                        <span class="text-green-400 font-medium">Advanced (Google campaigns)</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Registrar:</span>
                                        <span class="text-cyan-400 font-medium">${contractor.id === '1052' ? 'Squarespace Domains LLC' : 'Available'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Expiry:</span>
                                        <span class="text-orange-400 font-medium">${contractor.id === '1052' ? '2026-03-16' : 'Available'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Technical Analysis -->
                            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                                <h4 class="font-medium text-blue-300 mb-3">Technical Analysis</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Platform:</span>
                                        <span class="text-blue-400 font-medium">${contractor.intelligence.platformDetection}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Performance:</span>
                                        <span class="text-foreground font-medium">Mobile: ${contractor.intelligence.websiteSpeed.mobile}/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Mobile Ready:</span>
                                        <span class="${contractor.intelligence.websiteSpeed.mobile >= 80 ? 'text-green-400' : 'text-yellow-400'} font-medium">${contractor.intelligence.websiteSpeed.mobile >= 80 ? 'Optimized' : 'Needs improvement'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Business Intelligence Summary -->
                    <div class="intelligence-section rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-emerald-300 mb-4 flex items-center">
                            <i data-lucide="building-2" class="w-5 h-5 mr-2"></i>
                            Business Intelligence Summary
                        </h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="space-y-3">
                                <h4 class="font-medium text-emerald-200 text-sm">Sophistication Profile</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Business Maturity:</span>
                                        <span class="text-emerald-400 font-medium">${contractor.businessHealth}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Marketing Sophistication:</span>
                                        <span class="text-blue-400 font-medium">${contractor.sophisticationTier === 'Professional' ? 'ADVANCED' : contractor.sophisticationTier === 'Growing' ? 'MODERATE' : 'BASIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Digital Presence:</span>
                                        <span class="text-green-400 font-medium">ACTIVE</span>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h4 class="font-medium text-blue-200 text-sm">Outreach Intelligence</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Approach:</span>
                                        <span class="text-blue-400 font-medium">ROI-Focused</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Best Timing:</span>
                                        <span class="text-foreground font-medium">${contractor.intelligence.businessHours}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Conversion Probability:</span>
                                        <span class="text-green-400 font-medium">HIGH</span>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h4 class="font-medium text-purple-200 text-sm">Decision Maker</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Role:</span>
                                        <span class="text-purple-400 font-medium">Business Owner</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Email Quality:</span>
                                        <span class="text-emerald-400 font-medium">${contractor.emailQuality.replace('_', ' ')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Trust Score:</span>
                                        <span class="text-blue-400 font-medium">${contractor.trustScore}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCampaignsTab(contractor) {
            if (!contractor.hasCampaign || !contractor.campaignData) {
                return `
                    <div id="campaigns-tab" class="text-center py-12">
                        <i data-lucide="mail-x" class="w-16 h-16 text-muted-foreground mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-foreground mb-2">No Campaign Data</h3>
                        <p class="text-muted-foreground mb-4">This contractor doesn't have campaign sequences available yet.</p>
                        <button class="bg-primary/20 text-primary px-4 py-2 rounded-lg">Generate Campaign</button>
                    </div>
                `;
            }

            return `
                <div id="campaigns-tab" class="space-y-6">
                    <!-- Campaign Overview -->
                    <div class="intelligence-section rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-blue-300 mb-4 flex items-center">
                            <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                            Email Campaign Sequence
                        </h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                                <h4 class="font-medium text-blue-300 mb-3">Campaign Details</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Total Emails:</span>
                                        <span class="text-blue-400 font-medium">${contractor.campaignData.emailSequences.length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Company:</span>
                                        <span class="text-foreground font-medium">${contractor.campaignData.companyName || contractor.businessName}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Email Length:</span>
                                        <span class="text-foreground font-medium">${contractor.campaignData.messagingPreferences?.emailLength || 'Standard'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
                                <h4 class="font-medium text-emerald-300 mb-3">Optimal Timing</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Best Days:</span>
                                        <span class="text-emerald-400 font-medium">${contractor.campaignData.contactTiming.bestDayEmail1}, ${contractor.campaignData.contactTiming.bestDayEmail2}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Morning Window:</span>
                                        <span class="text-emerald-400 font-medium">${contractor.campaignData.contactTiming.windowATime}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Evening Window:</span>
                                        <span class="text-emerald-400 font-medium">${contractor.campaignData.contactTiming.windowBTime}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Sequences - Complete List -->
                    <div class="space-y-4">
                        ${contractor.campaignData.emailSequences.map((email, index) => `
                            <div class="intelligence-section rounded-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-semibold text-foreground flex items-center">
                                        <div class="w-8 h-8 bg-primary/20 border border-primary/30 rounded-full flex items-center justify-center mr-3">
                                            <span class="text-primary font-bold text-sm">${email.emailNumber}</span>
                                        </div>
                                        Email ${email.emailNumber}
                                    </h4>
                                    <div class="flex items-center space-x-3">
                                        <span class="text-xs bg-primary/20 text-primary px-3 py-1 rounded-full">
                                            ${email.sendDay} at ${email.sendTime}
                                        </span>
                                        <span class="px-3 py-1 rounded text-xs font-medium campaign-status-${email.status}">
                                            ${email.status.toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Subject Line -->
                                <div class="mb-4">
                                    <label class="text-xs text-muted-foreground block mb-2">Subject Line</label>
                                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3">
                                        <div class="text-sm text-foreground font-medium">${email.subject}</div>
                                    </div>
                                    <button onclick="copyToClipboard('${email.subject}', event)" class="mt-2 text-xs text-primary hover:text-primary/80">
                                        <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i>
                                        Copy Subject
                                    </button>
                                </div>

                                <!-- Email Body -->
                                <div class="mb-4">
                                    <label class="text-xs text-muted-foreground block mb-2">Email Body</label>
                                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                        <div class="text-sm text-foreground leading-relaxed whitespace-pre-line">${email.body}</div>
                                    </div>
                                    <button onclick="copyToClipboard('${email.body.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', event)" class="mt-2 text-xs text-primary hover:text-primary/80">
                                        <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i>
                                        Copy Body
                                    </button>
                                </div>

                                <!-- Campaign Actions -->
                                <div class="flex items-center justify-between pt-4 border-t border-border/30">
                                    <div class="flex space-x-3">
                                        <button onclick="copyFullEmail('${email.subject}', '${email.body.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', event)" class="bg-blue-500/20 text-blue-300 px-4 py-2 rounded text-sm hover:bg-blue-500/30 transition-colors">
                                            <i data-lucide="copy" class="w-4 h-4 inline mr-2"></i>
                                            Copy Complete Email
                                        </button>
                                        <button onclick="updateCampaignStatus('${contractor.id}', ${email.emailNumber}, 'sent')" class="bg-green-500/20 text-green-300 px-4 py-2 rounded text-sm hover:bg-green-500/30 transition-colors">
                                            <i data-lucide="check" class="w-4 h-4 inline mr-2"></i>
                                            Mark as Sent
                                        </button>
                                        <button onclick="updateCampaignStatus('${contractor.id}', ${email.emailNumber}, 'opened')" class="bg-amber-500/20 text-amber-300 px-4 py-2 rounded text-sm hover:bg-amber-500/30 transition-colors">
                                            <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                                            Mark as Opened
                                        </button>
                                    </div>
                                    
                                    <!-- Status timestamps -->
                                    <div class="text-xs text-muted-foreground text-right">
                                        ${email.sentDate ? `<div>Sent: ${email.sentDate}</div>` : ''}
                                        ${email.openedDate ? `<div>Opened: ${email.openedDate}</div>` : ''}
                                        ${email.respondedDate ? `<div>Responded: ${email.respondedDate}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderNotesTab(contractor) {
            return `
                <div id="notes-tab" class="space-y-6">
                    <!-- Add New Note -->
                    <div class="intelligence-section rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-emerald-300 mb-4 flex items-center">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            Add New Note
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-muted-foreground block mb-2">Note Type</label>
                                <select id="note-type" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-foreground">
                                    <option value="manual">Manual Note</option>
                                    <option value="campaign">Campaign Activity</option>
                                    <option value="opportunity">Business Opportunity</option>
                                    <option value="follow-up">Follow-up Reminder</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="text-sm text-muted-foreground block mb-2">Note Content</label>
                                <textarea id="note-content" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-foreground" placeholder="Enter your note here..."></textarea>
                            </div>
                            
                            <button onclick="addNote('${contractor.id}')" class="bg-emerald-500/20 text-emerald-300 px-4 py-2 rounded-lg hover:bg-emerald-500/30 transition-colors">
                                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                Add Note
                            </button>
                        </div>
                    </div>

                    <!-- Notes History -->
                    <div class="intelligence-section rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-blue-300 mb-4 flex items-center">
                            <i data-lucide="clock" class="w-5 h-5 mr-2"></i>
                            Activity Timeline
                        </h3>
                        
                        <div class="space-y-4" id="notes-list">
                            ${contractor.notes.slice().reverse().map((note, index) => `
                                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <i data-lucide="${note.type === 'system' ? 'settings' : note.type === 'campaign' ? 'mail' : note.type === 'opportunity' ? 'trending-up' : 'user'}" class="w-4 h-4 text-${note.type === 'system' ? 'gray' : note.type === 'campaign' ? 'blue' : note.type === 'opportunity' ? 'emerald' : 'purple'}-400"></i>
                                            <span class="text-xs px-2 py-1 rounded bg-${note.type === 'system' ? 'gray' : note.type === 'campaign' ? 'blue' : note.type === 'opportunity' ? 'emerald' : 'purple'}-500/20 text-${note.type === 'system' ? 'gray' : note.type === 'campaign' ? 'blue' : note.type === 'opportunity' ? 'emerald' : 'purple'}-300">
                                                ${note.type.toUpperCase()}
                                            </span>
                                        </div>
                                        <span class="text-xs text-muted-foreground">${note.date}</span>
                                    </div>
                                    <p class="text-sm text-foreground">${note.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function switchDossierTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.profile-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update content
            const tabContent = document.getElementById('dossier-tab-content');
            switch(tabName) {
                case 'intelligence':
                    tabContent.innerHTML = renderIntelligenceTab(currentProfile);
                    break;
                case 'campaigns':
                    tabContent.innerHTML = renderCampaignsTab(currentProfile);
                    break;
                case 'notes':
                    tabContent.innerHTML = renderNotesTab(currentProfile);
                    break;
            }
            lucide.createIcons();
        }

        function closeProfile() {
            const modal = document.getElementById('profile-modal');
            if (modal) {
                modal.remove();
            }
            currentProfile = null;
            currentProfileIndex = -1;
        }

        // Campaign management functions
        function updateCampaignStatus(contractorId, emailNumber, status) {
            const contractor = contractors.find(c => c.id === contractorId);
            if (contractor && contractor.campaignData) {
                const email = contractor.campaignData.emailSequences.find(e => e.emailNumber === emailNumber);
                if (email) {
                    email.status = status;
                    const today = new Date().toISOString().split('T')[0];
                    
                    switch(status) {
                        case 'sent':
                            email.sentDate = today;
                            break;
                        case 'opened':
                            if (!email.sentDate) email.sentDate = today;
                            email.openedDate = today;
                            break;
                        case 'responded':
                            if (!email.sentDate) email.sentDate = today;
                            if (!email.openedDate) email.openedDate = today;
                            email.respondedDate = today;
                            break;
                    }
                    
                    // Add note
                    contractor.notes.push({
                        date: today,
                        type: 'campaign',
                        content: `Email ${emailNumber} marked as ${status}`
                    });
                    
                    // Refresh the campaigns tab
                    switchDossierTab('campaigns');
                }
            }
        }

        function addNote(contractorId) {
            const noteType = document.getElementById('note-type').value;
            const noteContent = document.getElementById('note-content').value.trim();
            
            if (!noteContent) return;
            
            const contractor = contractors.find(c => c.id === contractorId);
            if (contractor) {
                const today = new Date().toISOString().split('T')[0];
                contractor.notes.push({
                    date: today,
                    type: noteType,
                    content: noteContent
                });
                
                // Clear the form
                document.getElementById('note-content').value = '';
                
                // Refresh the notes tab
                switchDossierTab('notes');
            }
        }

        function runFullAnalysis() {
            // Placeholder for full analysis functionality
            alert('Full analysis feature - integrate with actual intelligence system');
        }

        // Filter functionality with real CSV data
        function applyFilter(filterType, value = null) {
            switch(filterType) {
                case 'all':
                    filteredContractors = [...contractors];
                    break;
                // Completion Data Filters
                case 'high-completion':
                    filteredContractors = contractors.filter(c => c.completionScore >= 90);
                    break;
                case 'medium-completion':
                    filteredContractors = contractors.filter(c => c.completionScore >= 55 && c.completionScore < 90);
                    break;
                case 'low-completion':
                    filteredContractors = contractors.filter(c => c.completionScore < 55);
                    break;
                    
                // PSI Performance Filters
                case 'high-psi':
                    filteredContractors = contractors.filter(c => 
                        c.intelligence.websiteSpeed && 
                        ((c.intelligence.websiteSpeed.mobile + c.intelligence.websiteSpeed.desktop) / 2) >= 85
                    );
                    break;
                case 'medium-psi':
                    filteredContractors = contractors.filter(c => {
                        if (!c.intelligence.websiteSpeed) return false;
                        const avg = (c.intelligence.websiteSpeed.mobile + c.intelligence.websiteSpeed.desktop) / 2;
                        return avg >= 60 && avg < 85;
                    });
                    break;
                case 'low-psi':
                    filteredContractors = contractors.filter(c => {
                        if (!c.intelligence.websiteSpeed) return true; // Missing PSI = low
                        const avg = (c.intelligence.websiteSpeed.mobile + c.intelligence.websiteSpeed.desktop) / 2;
                        return avg < 60;
                    });
                    break;
                    
                // Reviews Intelligence Filters
                case 'high-rating':
                    filteredContractors = contractors.filter(c => c.googleRating >= 4.5);
                    break;
                case 'low-rating':
                    filteredContractors = contractors.filter(c => c.googleRating < 4.0);
                    break;
                case 'inactive-reviews':
                    filteredContractors = contractors.filter(c => c.intelligence.reviewsRecency === 'INACTIVE');
                    break;
                    
                // WHOIS Data Filters
                case 'domain-expiring':
                    filteredContractors = contractors.filter(c => 
                        c.intelligence.domainExpiry && c.intelligence.domainExpiry <= 90
                    );
                    break;
                case 'new-domain':
                    filteredContractors = contractors.filter(c => 
                        c.intelligence.domainAge && c.intelligence.domainAge < 2
                    );
                    break;
                    
                // Builder Platform Filters
                case 'has-builder':
                    filteredContractors = contractors.filter(c => 
                        c.intelligence.platformDetection && 
                        (c.intelligence.platformDetection.includes('Wix') || 
                         c.intelligence.platformDetection.includes('Squarespace') ||
                         c.intelligence.platformDetection.includes('Webflow'))
                    );
                    break;
                case 'wordpress':
                    filteredContractors = contractors.filter(c => 
                        c.intelligence.platformDetection && 
                        c.intelligence.platformDetection.includes('WordPress')
                    );
                    break;
                case 'custom-built':
                    filteredContractors = contractors.filter(c => 
                        !c.intelligence.platformDetection || 
                        c.intelligence.platformDetection === 'Custom' ||
                        c.intelligence.platformDetection === 'Unknown'
                    );
                    break;
                // Legacy filters for execution mode
                case 'active-campaigns':
                    filteredContractors = contractors.filter(c => c.hasCampaign);
                    break;
                case 'pending-setup':
                    filteredContractors = contractors.filter(c => !c.hasCampaign);
                    break;
                case 'high-engagement':
                    filteredContractors = contractors.filter(c => c.hasCampaign && c.googleRating >= 4.0);
                    break;
                case 'scheduled-today':
                    filteredContractors = contractors.filter(c => c.hasCampaign).slice(0, 1);
                    break;
            }
            
            // Update filter UI
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');
            
            renderContractors();
        }
        
        // Smart Filter System Functions
        function toggleModeFilters(mode) {
            // The new design uses CSS classes for show/hide
            // The .intelligence-only and .execution-only classes handle visibility automatically
            // Just update the body classes
            if (mode === 'intelligence') {
                document.body.classList.add('intelligence-mode');
                document.body.classList.remove('execution-mode');
            } else {
                document.body.classList.add('execution-mode');
                document.body.classList.remove('intelligence-mode');
            }
            
            // Clear active filters when switching modes for cleaner UX
            activeFilters = [];
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            
            // Reset to show all contractors
            filteredContractors = [...contractors];
            renderContractors();
            updateStats();
        }
        
        function toggleAdvancedFilters() {
            const advancedFilters = document.getElementById('advanced-filters');
            const chevron = document.getElementById('advanced-chevron');
            
            if (advancedFilters.classList.contains('hidden')) {
                advancedFilters.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                advancedFilters.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }
        
        function applyAdvancedFilter(filterType, value) {
            let filtered = [...contractors];
            
            switch(filterType) {
                case 'category':
                    if (value) {
                        filtered = filtered.filter(c => c.category.toLowerCase().includes(value.toLowerCase()));
                    }
                    break;
                case 'minReviews':
                    filtered = filtered.filter(c => c.reviewsCount >= parseInt(value));
                    break;
            }
            
            filteredContractors = filtered;
            renderContractors();
        }
        
        function applyRatingFilter() {
            const ratingMin = document.getElementById('rating-min').value;
            document.getElementById('rating-display').textContent = `${ratingMin}+`;
            
            filteredContractors = contractors.filter(c => c.googleRating >= parseFloat(ratingMin));
            renderContractors();
        }
        
        function applySuggestion(suggestionType) {
            switch(suggestionType) {
                case 'high-opportunity':
                    applyFilter('opportunity-rich');
                    break;
                case 'review-boost':
                    filteredContractors = contractors.filter(c => c.intelligence.reviewsRecency !== 'ACTIVE' && c.reviewsCount < 10);
                    break;
                case 'website-speed':
                    filteredContractors = contractors.filter(c => c.intelligence.websiteSpeed.mobile < 60);
                    break;
            }
            
            // Update UI
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            
            renderContractors();
        }
        
        function updateSmartSuggestions() {
            // Dynamic suggestions based on current data
            const suggestions = document.getElementById('smart-suggestions');
            const highOpportunity = contractors.filter(c => c.completionScore >= 85 && c.intelligence.reviewsRecency !== 'ACTIVE').length;
            const needReviewBoost = contractors.filter(c => c.intelligence.reviewsRecency !== 'ACTIVE' && c.reviewsCount < 10).length;
            const slowWebsites = contractors.filter(c => c.intelligence.websiteSpeed.mobile < 60).length;
            
            suggestions.innerHTML = `
                <div class="text-xs text-foreground cursor-pointer hover:text-primary transition-colors p-2 hover:bg-primary/5 rounded flex items-center" onclick="applySuggestion('high-opportunity')">
                    <i data-lucide="trending-up" class="w-3 h-3 mr-2 text-green-400"></i>
                    ${highOpportunity} contractors with high growth potential
                </div>
                <div class="text-xs text-foreground cursor-pointer hover:text-primary transition-colors p-2 hover:bg-primary/5 rounded flex items-center" onclick="applySuggestion('review-boost')">
                    <i data-lucide="star" class="w-3 h-3 mr-2 text-yellow-400"></i>
                    ${needReviewBoost} need immediate review optimization
                </div>
                <div class="text-xs text-foreground cursor-pointer hover:text-primary transition-colors p-2 hover:bg-primary/5 rounded flex items-center" onclick="applySuggestion('website-speed')">
                    <i data-lucide="zap" class="w-3 h-3 mr-2 text-red-400"></i>
                    ${slowWebsites} ${slowWebsites === 1 ? 'has' : 'have'} critical website speed issues
                </div>
            `;
            
            // Force icon rendering
            setTimeout(() => {
                lucide.createIcons();
            }, 50);
        }

        // Active filters array for cumulative filtering
        let activeFilters = [];
        
        function toggleFilter(filterName) {
            const filterElement = document.querySelector(`[data-filter="${filterName}"]`);
            
            if (activeFilters.includes(filterName)) {
                // Remove filter if already active
                activeFilters = activeFilters.filter(f => f !== filterName);
                filterElement.classList.remove('active');
            } else {
                // Add filter if not active
                activeFilters.push(filterName);
                filterElement.classList.add('active');
            }
            
            // Apply cumulative filters
            applyCumulativeFilters();
        }
        
        function applyCumulativeFilters() {
            if (activeFilters.length === 0) {
                filteredContractors = [...contractors];
            } else {
                // Use intelligent service for fast filtering if available
                if (contractorService && contractorService.isLoaded) {
                    filteredContractors = contractorService.searchContractors(activeFilters);
                } else {
                    // Fallback to legacy filtering
                    filteredContractors = contractors.filter(contractor => {
                        return activeFilters.every(filterName => {
                            return matchesFilter(contractor, filterName);
                        });
                    });
                }
            }
            
            renderContractors();
            updateStats();
        }
        
        function matchesFilter(contractor, filterName) {
            switch(filterName) {
                // Completion Data
                case 'completion-85-100':
                    return contractor.completionScore >= 85 && contractor.completionScore <= 100;
                case 'completion-55-80':
                    return contractor.completionScore >= 55 && contractor.completionScore <= 80;
                case 'completion-20-50':
                    return contractor.completionScore >= 20 && contractor.completionScore <= 50;
                case 'completion-0':
                    return contractor.completionScore === 0;
                    
                // PSI Performance
                case 'high-psi':
                    return contractor.intelligence?.websiteSpeed?.mobile >= 85;
                case 'medium-psi':
                    return contractor.intelligence?.websiteSpeed?.mobile >= 60 && contractor.intelligence?.websiteSpeed?.mobile < 85;
                case 'low-psi':
                    return contractor.intelligence?.websiteSpeed?.mobile < 60;
                    
                // Campaign Status
                case 'campaign-ready':
                    return contractor.hasCampaign && contractor.hasFocusGroup;
                case 'campaign-scheduled':
                    return contractor.hasCampaign && contractor.campaignData?.emailSequences?.some(email => email.status === 'scheduled');
                case 'campaign-sent':
                    return contractor.hasCampaign && contractor.campaignData?.emailSequences?.some(email => email.status === 'sent');
                case 'campaign-ready-to-send':
                    return contractor.hasCampaign && contractor.campaignData?.emailSequences?.some(email => email.status === 'pending');
                case 'setup-required':
                    return contractor.hasFocusGroup && !contractor.hasCampaign;
                    
                // Reviews
                case 'high-rating':
                    return contractor.googleRating >= 4.5;
                case 'low-rating':
                    return contractor.googleRating < 4.0;
                case 'inactive-reviews':
                    return contractor.intelligence?.reviewsRecency === 'INACTIVE';
                    
                // Technology
                case 'builder-platform':
                    return contractor.intelligence?.platformDetection === 'Squarespace';
                case 'custom-platform':
                    return contractor.intelligence?.platformDetection === 'WordPress' || 
                           contractor.intelligence?.platformDetection === 'Basic HTML' ||
                           contractor.intelligence?.platformDetection === 'Custom WordPress' ||
                           contractor.intelligence?.platformDetection === 'Elementor';
                    
                // Location & Business
                case 'roofing':
                    return contractor.category?.toLowerCase().includes('roofing');
                case 'hvac':
                    return contractor.category?.toLowerCase().includes('hvac');
                case 'idaho':
                    return contractor.address?.includes('ID') || contractor.address?.includes('Idaho');
                case 'kansas':
                    return contractor.address?.includes('KS') || contractor.address?.includes('Kansas');
                case 'colorado':
                    return contractor.address?.includes('CO') || contractor.address?.includes('Colorado');
                case 'texas':
                    return contractor.address?.includes('TX') || contractor.address?.includes('Texas');
                    
                default:
                    return true;
            }
        }

        function clearAllFilters() {
            activeFilters = [];
            filteredContractors = [...contractors];
            // Reset active filter pills
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            document.querySelector('[data-filter="all"]').classList.add('active');
            renderContractors();
            updateStats();
        }

        function updateStats() {
            // Defensive coding - check if elements exist before updating
            const contractorCountEl = document.getElementById('contractor-count');
            if (contractorCountEl) {
                contractorCountEl.textContent = `${filteredContractors.length} contractors`;
            }
            
            const totalStatEl = document.getElementById('total-stat');
            if (totalStatEl) {
                totalStatEl.textContent = filteredContractors.length;
            }
            
            const campaignsStatEl = document.getElementById('campaigns-stat');
            if (campaignsStatEl) {
                campaignsStatEl.textContent = filteredContractors.filter(c => c.hasCampaign).length;
            }
            
            const ratingStatEl = document.getElementById('rating-stat');
            if (ratingStatEl) {
                ratingStatEl.textContent = filteredContractors.filter(c => c.googleRating >= 4.5).length;
            }
            
            const showingTextEl = document.getElementById('showing-text');
            if (showingTextEl) {
                showingTextEl.textContent = `Showing ${filteredContractors.length} contractors with complete dossier intelligence`;
            }
            
            console.log(`Stats updated: ${filteredContractors.length} contractors total`);
        }

        // Copy functions
        function copyToClipboard(text, event) {
            event.stopPropagation();
            navigator.clipboard.writeText(text).then(() => {
                const button = event.target.closest('button');
                const originalText = button.textContent;
                button.innerHTML = '<i data-lucide="check" class="w-3 h-3 inline mr-1"></i>Copied!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        }

        function copyFullEmail(subject, body, event) {
            event.stopPropagation();
            const fullEmail = `Subject: ${subject}\n\n${body}`;
            copyToClipboard(fullEmail, event);
        }

        // Mode switching with smart filter integration
        let currentMode = 'intelligence'; // Default mode
        
        function switchToIntelligenceMode() {
            document.getElementById('intelligence-mode').classList.add('active');
            document.getElementById('execution-mode').classList.remove('active');
            document.body.classList.remove('execution-mode');
            document.body.classList.add('intelligence-mode');
            currentMode = 'intelligence';
            toggleModeFilters('intelligence');
            renderContractors();
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }
        
        function switchToExecutionMode() {
            document.getElementById('execution-mode').classList.add('active');
            document.getElementById('intelligence-mode').classList.remove('active');
            document.body.classList.remove('intelligence-mode');
            document.body.classList.add('execution-mode');
            currentMode = 'execution';
            toggleModeFilters('execution');
            renderContractors();
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }
        
        document.getElementById('intelligence-mode').addEventListener('click', switchToIntelligenceMode);
        document.getElementById('execution-mode').addEventListener('click', switchToExecutionMode);

        // Filter pill event listeners
        document.addEventListener('click', function(e) {
            if (e.target.closest('.filter-pill')) {
                const pill = e.target.closest('.filter-pill');
                const filter = pill.dataset.filter;
                
                // Remove active from all pills
                document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                
                // Add active to clicked pill
                pill.classList.add('active');
                
                // Apply filter
                applyFilter(filter);
            }
        });

        // AGGRESSIVE ICON RENDERING FIX
        function forceIconRendering() {
            try {
                lucide.createIcons();
                
                // Force all icons, don't check if empty
                const iconElements = document.querySelectorAll('[data-lucide]');
                iconElements.forEach(el => {
                    const iconName = el.getAttribute('data-lucide');
                    if (iconName) {
                        try {
                            let size = '16';
                            if (el.classList.contains('w-6')) size = '24';
                            if (el.classList.contains('w-5')) size = '20';
                            
                            el.innerHTML = lucide.icons[iconName].toSvg({
                                width: size,
                                height: size,
                                stroke: 'currentColor'
                            });
                        } catch (e) {
                            console.warn('Icon not found:', iconName);
                        }
                    }
                });
            } catch (e) {
                console.error('Icon rendering failed:', e);
            }
        }
        
        // Less aggressive icon observer to avoid interfering with clicks
        let iconRenderTimeout;
        const iconObserver = new MutationObserver(() => {
            clearTimeout(iconRenderTimeout);
            iconRenderTimeout = setTimeout(forceIconRendering, 200);
        });
        
        // Start observing with reduced frequency  
        if (document.body) {
            iconObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize mode properly
            currentMode = 'intelligence';
            
            // Initialize the intelligent data service
            await initializeDataService();
            
            // Start in intelligence mode
            document.body.classList.add('intelligence-mode');
            document.getElementById('intelligence-mode').classList.add('active');
            
            // Initialize smart filters
            toggleModeFilters('intelligence');
            updateSmartSuggestions();
            
            // Start icon observer
            iconObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // NUCLEAR APPROACH - Force all icons to render
            forceIconRendering();
            setTimeout(forceIconRendering, 50);
            setTimeout(forceIconRendering, 100);
            setTimeout(forceIconRendering, 200);
            setTimeout(forceIconRendering, 500);
            setTimeout(forceIconRendering, 1000);
        });
    </script>

</body>
</html>